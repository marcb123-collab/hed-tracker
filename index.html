<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Marc's HED Tracker</title>
    
    <!-- PWA / iOS Standalone App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HED">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .dashboard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 14px;
            padding-top: max(12px, env(safe-area-inset-top));
        }
        
        .dash-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .dash-title { font-size: 16px; font-weight: 600; }
        .dash-date { font-size: 12px; opacity: 0.9; }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .stat {
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 8px 6px;
            text-align: center;
        }
        
        .stat-value { font-size: 18px; font-weight: 700; }
        .stat-label { font-size: 9px; opacity: 0.8; text-transform: uppercase; }
        
        .progress-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .progress-item { flex: 1; }
        .progress-label { font-size: 9px; opacity: 0.8; margin-bottom: 2px; }
        .progress-bar { height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }
        .progress-fill { height: 100%; background: white; border-radius: 2px; transition: width 0.3s; }
        .progress-fill.protein { background: #90EE90; }
        .progress-fill.sodium { background: #FFB6C1; }
        
        .status-row {
            display: flex;
            gap: 6px;
            font-size: 11px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .status-chip {
            background: rgba(255,255,255,0.15);
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .deficit { color: #90EE90; }
        .over { color: #FFB6C1; }
        
        .copy-btn {
            background: rgba(255,255,255,0.25);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .copy-btn:active { background: rgba(255,255,255,0.4); }
        
        .workout-btn {
            background: rgba(255,255,255,0.3);
            border: 2px solid rgba(255,255,255,0.6);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .workout-btn.done {
            background: rgba(76,175,80,0.8);
            border-color: rgba(76,175,80,1);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            font-size: 12px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #666;
        }
        
        .tab.active { color: #667eea; border-bottom-color: #667eea; font-weight: 600; }
        
        /* Content */
        .content { flex: 1; overflow-y: auto; }
        .pane { display: none; padding: 10px; }
        .pane.active { display: block; }
        
        /* Summary */
        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .summary-list { font-size: 12px; }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .summary-item:last-child { border-bottom: none; }
        
        .item-left { display: flex; align-items: center; gap: 6px; flex: 1; }
        .item-dot { width: 6px; height: 6px; border-radius: 50%; }
        .item-dot.food { background: #4CAF50; }
        .item-dot.exercise { background: #2196F3; }
        .item-name { flex: 1; }
        .item-values { color: #666; font-size: 11px; }
        .item-delete { background: none; border: none; color: #ccc; font-size: 16px; padding: 0 4px; cursor: pointer; }
        .item-delete:hover { color: #f44336; }
        
        .no-entries { color: #999; text-align: center; padding: 20px; font-size: 13px; }
        
        /* Quick buttons */
        .section-title {
            font-size: 11px;
            font-weight: 600;
            color: #666;
            margin: 12px 0 8px 0;
        }
        
        .quick-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .qbtn {
            background: #f5f5f5;
            border: none;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .qbtn:active { background: #e8e8e8; }
        .qbtn.food { border-left: 3px solid #4CAF50; }
        .qbtn.exercise { border-left: 3px solid #2196F3; }
        .qbtn.action { background: #E8F0FE; border-left: 3px solid #4285F4; }
        .qbtn.photo { background: #FFF3E0; border-left: 3px solid #FF9800; }
        
        .qbtn-cal { color: #888; font-size: 10px; }
        
        /* Input bar */
        .input-bar {
            background: white;
            padding: 10px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
            padding-bottom: max(20px, calc(env(safe-area-inset-bottom) + 10px));
            position: sticky;
            bottom: 0;
        }
        
        .input-field {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }
        
        .input-field:focus { border-color: #667eea; }
        
        .input-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .input-btn.add { background: #667eea; color: white; }
        .input-btn.photo { background: #FF9800; color: white; }
        
        /* History */
        .history-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            position: relative;
        }
        
        .history-date {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        .history-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            font-size: 11px;
            text-align: center;
        }
        
        .history-stat-value { font-weight: 600; font-size: 14px; }
        .history-stat-label { color: #888; font-size: 9px; }
        .history-stat.good .history-stat-value { color: #4CAF50; }
        .history-stat.bad .history-stat-value { color: #f44336; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        
        .modal.open { display: flex; }
        
        .modal-box {
            background: white;
            border-radius: 14px;
            padding: 20px;
            width: 90%;
            max-width: 320px;
        }
        
        .modal-title { font-size: 16px; font-weight: 600; margin-bottom: 14px; }
        
        .modal-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .modal-btns { display: flex; gap: 10px; justify-content: flex-end; }
        
        .modal-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            cursor: pointer;
        }
        
        .modal-btn.cancel { background: #f0f0f0; }
        .modal-btn.save { background: #667eea; color: white; }
        
        .photo-preview { max-width: 100%; max-height: 150px; border-radius: 8px; margin-bottom: 10px; }
        
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 13px;
            z-index: 200;
            display: none;
        }
        
        .toast.show { display: block; }
        
        /* Hidden */
        #photoInput, #cameraInput { display: none; }
    </style>
</head>
<body>
    <!-- Dashboard -->
    <div class="dashboard">
        <div class="dash-header">
            <span class="dash-title">Marc's HED Tracker</span>
            <div style="display:flex;align-items:center;gap:8px;">
                <button onclick="location.reload()" style="width:28px;height:28px;border-radius:50%;border:none;background:rgba(255,255,255,0.3);color:white;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;">‚Üª</button>
                <button id="syncStatus" onclick="googleSignIn()" style="width:28px;height:28px;border-radius:50%;border:none;background:rgba(255,255,255,0.3);color:white;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;">üë§</button>
                <span class="dash-date" id="dateDisplay"></span>
            </div>
        </div>
        <div class="stats-row">
            <div class="stat">
                <div class="stat-value" id="calIn">0</div>
                <div class="stat-label">CAL IN</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="protein">0g</div>
                <div class="stat-label">PROTEIN</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="burned">0</div>
                <div class="stat-label">BURNED</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="net">0</div>
                <div class="stat-label">NET</div>
            </div>
        </div>
        <div class="progress-row">
            <div class="progress-item">
                <div class="progress-label">Calories <span id="calPct">0</span>%</div>
                <div class="progress-bar"><div class="progress-fill" id="calBar" style="width:0%"></div></div>
            </div>
            <div class="progress-item">
                <div class="progress-label">Protein <span id="worPct">0</span>%</div>
                <div class="progress-bar"><div class="progress-fill protein" id="worBar" style="width:0%"></div></div>
            </div>
            <div class="progress-item">
                <div class="progress-label">Sodium <span id="sodiumPct">0</span>%</div>
                <div class="progress-bar"><div class="progress-fill sodium" id="sodiumBar" style="width:0%"></div></div>
            </div>
        </div>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="showPane('today')">Today</button>
        <button class="tab" onclick="showPane('add')">Add</button>
        <button class="tab" onclick="showPane('plan')">Exercise</button>
        <button class="tab" onclick="showPane('history')">History</button>
    </div>
    
    <!-- Content -->
    <div class="content">
        <!-- Today Pane -->
        <div class="pane active" id="todayPane">
            <!-- Goals Section -->
            <div class="summary-card" style="margin-bottom:10px;">
                <div class="summary-header">üéØ Daily Goals</div>
                <div style="display:flex;justify-content:space-around;padding:8px 0;font-size:12px;">
                    <div style="text-align:center;">
                        <div style="font-weight:600;" id="goalCal">0/1600</div>
                        <div style="color:#666;font-size:10px;">Net Cal</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-weight:600;" id="goalProtein">0/110g</div>
                        <div style="color:#666;font-size:10px;">Protein</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-weight:600;" id="goalSodium">0/2300mg</div>
                        <div style="color:#666;font-size:10px;">Sodium</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-weight:600;" id="goalSteps">0/7500</div>
                        <div style="color:#666;font-size:10px;">Steps</div>
                    </div>
                </div>
            </div>
            
            <!-- Today's Log -->
            <div class="summary-card">
                <div class="summary-header">
                    <span>Today's Log</span>
                    <div style="display:flex;gap:4px;">
                        <button class="qbtn action" onclick="copySummary()" style="font-size:10px;padding:4px 8px;">üìã Summary</button>
                        <button class="qbtn action" onclick="copyFull()" style="font-size:10px;padding:4px 8px;">üìã Full</button>
                    </div>
                </div>
                <div class="summary-list" id="logList">
                    <div class="no-entries">No entries yet</div>
                </div>
            </div>
            
            <!-- Nutrition Summary -->
            <div class="summary-card" style="margin-top:10px;">
                <div class="summary-header">üìä Summary</div>
                <div id="nutritionSummary" style="font-size:12px;padding:8px 0;">
                    <!-- Weight Section -->
                    <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eee;background:#f8f9ff;margin:-8px -12px 8px -12px;padding:8px 12px;">
                        <span style="font-weight:600;">‚öñÔ∏è Current Weight</span>
                        <span id="weightDisplay" style="font-weight:600;color:#667eea;">--</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #eee;">
                        <span>Weight Trend (7 days)</span>
                        <span id="weightTrend">--</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #eee;">
                        <span>Avg Daily Deficit</span>
                        <span id="avgDeficit">--</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #eee;">
                        <span>Workout Streak</span>
                        <span id="workoutStreak">--</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #eee;">
                        <span>Protein Avg (7 days)</span>
                        <span id="proteinAvg">--</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #eee;">
                        <span>Sodium Avg (7 days)</span>
                        <span id="sodiumAvg">--</span>
                    </div>
                    
                    <!-- Today's Nutrients -->
                    <div style="margin-top:10px;padding-top:8px;border-top:2px solid #eee;">
                        <div style="font-weight:600;margin-bottom:6px;">Today's Nutrients*</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px;">
                            <div style="display:flex;justify-content:space-between;"><span>Fiber</span><span id="fiberToday">0/28g</span></div>
                            <div style="display:flex;justify-content:space-between;"><span>Sugar</span><span id="sugarToday">0/25g</span></div>
                            <div style="display:flex;justify-content:space-between;"><span>Potassium</span><span id="potassiumToday">0/3500mg</span></div>
                            <div style="display:flex;justify-content:space-between;"><span>Calcium</span><span id="calciumToday">0/1000mg</span></div>
                            <div style="display:flex;justify-content:space-between;"><span>Iron</span><span id="ironToday">0/8mg</span></div>
                            <div style="display:flex;justify-content:space-between;"><span>Vitamin D</span><span id="vitDToday">0/800IU</span></div>
                            <div style="display:flex;justify-content:space-between;"><span>Magnesium</span><span id="magnesiumToday">0/420mg</span></div>
                        </div>
                        <div style="font-size:9px;color:#999;margin-top:6px;">*Estimates based on visual/textual food analysis</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add Pane -->
        <div class="pane" id="addPane">
            <!-- Sync buttons at top -->
            <div class="quick-grid" style="margin-bottom:12px;">
                <button class="qbtn action" onclick="refreshFromSheets()">‚òÅÔ∏è Refresh</button>
                <button class="qbtn action" onclick="syncSteps()">üîÑ Sync Steps</button>
                <button class="qbtn action" onclick="syncWeight()">‚öñÔ∏è Sync Weight</button>
            </div>
            
            <div class="section-title">üçΩÔ∏è FOOD <span id="foodToggle" onclick="toggleFoodList()" style="font-size:10px;color:#667eea;cursor:pointer;float:right;">Show All ‚ñº</span></div>
            <div class="quick-grid" id="foodButtonsQuick"></div>
            <div class="quick-grid" id="foodButtonsFull" style="display:none;"></div>
            
            <div class="section-title">üí™ EXERCISE</div>
            <div class="quick-grid" id="exerciseButtons"></div>
            <div style="margin: 10px 0;">
                <button class="workout-btn" id="workoutBtn" onclick="toggleWorkout()" style="width:100%;padding:12px;font-size:14px;">‚òê Workout Done</button>
            </div>
        </div>
        
        <!-- Plan Pane -->
        <div class="pane" id="planPane">
            <div class="summary-card">
                <div class="summary-header">üìÖ Weekly Exercise Plan</div>
                <p style="font-size:11px;color:#666;margin-bottom:10px;">6-day rotation. Workout 10-11am (8-9am if calls). Sunday rest.</p>
            </div>
            <div id="planList"></div>
        </div>
        
        <!-- History Pane -->
        <div class="pane" id="historyPane">
            <div id="historyList"></div>
        </div>
    </div>
    
    <!-- Input Bar -->
    <div class="input-bar">
        <input type="text" class="input-field" id="inputField" placeholder="Paste: Saba Set 650cal 35g">
        <button class="input-btn add" onclick="parseInput()">‚ñ∂</button>
    </div>
    
    <!-- Hidden inputs -->
    <input type="file" id="photoInput" accept="image/*" onchange="handlePhoto(event)" style="display:none;">
    <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handlePhoto(event)" style="display:none;">
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- Custom Food Modal -->
    <div class="modal" id="customModal">
        <div class="modal-box">
            <div class="modal-title">Add Custom Food</div>
            <input type="text" class="modal-input" id="customName" placeholder="Food name">
            <input type="number" class="modal-input" id="customCal" placeholder="Calories">
            <input type="number" class="modal-input" id="customPro" placeholder="Protein (g)">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeModal('customModal')">Cancel</button>
                <button class="modal-btn save" onclick="saveCustom()">Add</button>
            </div>
        </div>
    </div>
    
    <!-- Photo Modal -->
    <div class="modal" id="photoModal">
        <div class="modal-box">
            <div class="modal-title">Log Meal</div>
            <img id="photoPreview" class="photo-preview" style="display:none">
            <input type="text" class="modal-input" id="photoName" placeholder="Meal name">
            <input type="number" class="modal-input" id="photoCal" placeholder="Calories">
            <input type="number" class="modal-input" id="photoPro" placeholder="Protein (g)">
            <p style="font-size:11px;color:#888;margin-bottom:12px;">üí° Send photo to Claude for estimate</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeModal('photoModal')">Cancel</button>
                <button class="modal-btn save" onclick="savePhoto()">Add</button>
            </div>
        </div>
    </div>
    
    <!-- Steps Modal -->
    <div class="modal" id="stepsModal">
        <div class="modal-box">
            <div class="modal-title">Manual Steps</div>
            <input type="number" class="modal-input" id="stepsInput" placeholder="Number of steps">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeModal('stepsModal')">Cancel</button>
                <button class="modal-btn save" onclick="saveManualSteps()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Config
        const CLIENT_ID = '163799557992-hgstjj16f2d587jjicjonmlulaqsh552.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/fitness.activity.read https://www.googleapis.com/auth/fitness.body.read https://www.googleapis.com/auth/spreadsheets';
        const SHEET_ID = '13jRxb7mOAZUyi1mO3z005W6gtG5Kh4X5PZPM4FTwNMY';
        const TARGETS = { 
            cal: 1600, protein: 110, sodium: 2300, 
            fiber: 28, sugar: 25, potassium: 3500, 
            calcium: 1000, iron: 8, vitD: 800, magnesium: 420 
        };
        
        let tokenClient, accessToken = localStorage.getItem('hed_token');
        let tokenExpiry = parseInt(localStorage.getItem('hed_token_expiry')) || 0;
        let state = { 
            date: '', calIn: 0, calOut: 0, protein: 0, sodium: 0, 
            fiber: 0, sugar: 0, potassium: 0, calcium: 0, iron: 0, vitD: 0, magnesium: 0,
            steps: 0, workout: false, entries: [] 
        };
        let photoData = null;
        let showAllFoods = false;
        
        // Check if token needs refresh (expired or missing)
        function tokenNeedsRefresh() {
            if (!accessToken) return true;
            // Only refresh if actually expired (not just close to expiry)
            return Date.now() > tokenExpiry;
        }
        
        // Check if token is likely still valid (within 1 hour of last use)
        function tokenLikelyValid() {
            if (!accessToken) return false;
            // Token is valid for 1 hour, but we stored the expiry
            // If expiry is in the future, token is valid
            return Date.now() < tokenExpiry;
        }
        
        // Silently refresh token - returns true if successful
        async function refreshTokenSilently() {
            return new Promise((resolve) => {
                if (!tokenClient) { resolve(false); return; }
                try {
                    tokenClient.requestAccessToken({ prompt: '' });
                    // The callback in initGoogle will handle the response
                    setTimeout(() => resolve(!!accessToken), 3000);
                } catch (e) {
                    console.log('Silent refresh failed:', e);
                    resolve(false);
                }
            });
        }
        
        // Ensure valid token before API calls - only prompt if actually needed
        async function ensureValidToken() {
            // If token looks valid, just use it
            if (tokenLikelyValid()) {
                return true;
            }
            // Token expired - try silent refresh first
            if (accessToken && tokenClient) {
                console.log('Token expired, attempting silent refresh...');
                const refreshed = await refreshTokenSilently();
                if (refreshed) return true;
            }
            // No valid token - user needs to sign in manually
            console.log('No valid token, manual sign-in required');
            return false;
        }
        
        // Weekly plan data with exercise details and hints
        const EXERCISE_HINTS = {
            // Ab Circuit
            'Mountain Climbers 3x30': 'Plank position, drive knees to chest alternating fast',
            'Bicycle Crunches 3x20': 'On back, alternate elbow to opposite knee',
            'Flutter Kicks 3x30': 'On back, legs straight, small fast up/down kicks',
            'Russian Twists 3x20': 'Seated, lean back, rotate torso side to side',
            'Leg Raises 3x15': 'On back, legs straight, lift to ceiling, lower slow',
            'Hollow Body Hold 3x30sec': 'On back, arms/legs lifted, hold banana shape',
            'Plank 3x45sec': 'Forearms and toes, body straight, hold tight',
            // Bike
            'Warm up 5 min': 'Light pace to get blood flowing',
            'Moderate pace 30-35 min': 'Steady effort, can still talk',
            'Cool down 5 min': 'Slow pace, let heart rate drop',
            // Resistance - Bending Bar
            'Front Chest Press 3x15 (hold 2 sec)': 'Hold bar in front, squeeze inward, hold 2 sec',
            'Overhead Press & Bend 3x12': 'Bar overhead, bend/squeeze down',
            'Behind-the-Back Squeeze 3x15': 'Bar behind lower back, squeeze handles together',
            'Abdominal Crunch with Bar 3x15': 'Squeeze bar while crunching abs',
            'Rotational Twists 3x10 each side': 'Hold squeezed bar, rotate torso left/right',
            // Resistance - Bands
            'Push-Ups 3x5-15': 'Hands on floor, lower chest, push up (start with wall/knees)',
            'Band Pull-Aparts 3x20': 'Hold band in front, pull hands apart stretching band',
            'Rapid Punches with Band 3x50': 'Band behind back, punch forward fast alternating',
            'Cross Curls 3x12 each side': 'Band under feet, curl across body to opposite shoulder',
            'Band Chest Fly 3x15': 'Band behind back, arms wide, squeeze together in front',
            // Sunday
            '45-60 min walk': '45-60 min comfortable pace',
            'Stretching': 'Gentle stretches for major muscle groups',
            'Foam rolling (optional)': 'Roll out tight spots, especially legs and back'
        };
        
        const WEEKLY_PLAN = [
            { day: 'Monday', workout: 'Ab Circuit', cal: 200, time: '10-11am', 
              details: '~20-25 min circuit-style. 30-60 sec rest after each round. 3 rounds.',
              exercises: ['Mountain Climbers 3x30', 'Bicycle Crunches 3x20', 'Flutter Kicks 3x30', 'Russian Twists 3x20', 'Leg Raises 3x15', 'Hollow Body Hold 3x30sec', 'Plank 3x45sec'] },
            { day: 'Tuesday', workout: 'Bike', cal: 400, time: '10-11am', 
              details: '35-40 min moderate pace.',
              exercises: ['Warm up 5 min', 'Moderate pace 30-35 min', 'Cool down 5 min'] },
            { day: 'Wednesday', workout: 'Resistance', cal: 180, time: '10-11am', 
              details: '~35-40 min. Chest, shoulders, and core.',
              exercises: ['‚Äî Muscle Bending Bar ‚Äî', 'Front Chest Press 3x15 (hold 2 sec)', 'Overhead Press & Bend 3x12', 'Behind-the-Back Squeeze 3x15', 'Abdominal Crunch with Bar 3x15', 'Rotational Twists 3x10 each side', '‚Äî Bands & Bodyweight ‚Äî', 'Push-Ups 3x5-15', 'Band Pull-Aparts 3x20', 'Rapid Punches with Band 3x50', 'Cross Curls 3x12 each side', 'Band Chest Fly 3x15'] },
            { day: 'Thursday', workout: 'Ab Circuit', cal: 200, time: '10-11am', 
              details: '~20-25 min circuit-style. 30-60 sec rest after each round. 3 rounds.',
              exercises: ['Mountain Climbers 3x30', 'Bicycle Crunches 3x20', 'Flutter Kicks 3x30', 'Russian Twists 3x20', 'Leg Raises 3x15', 'Hollow Body Hold 3x30sec', 'Plank 3x45sec'] },
            { day: 'Friday', workout: 'Bike', cal: 400, time: '10-11am', 
              details: '35-40 min moderate pace.',
              exercises: ['Warm up 5 min', 'Moderate pace 30-35 min', 'Cool down 5 min'] },
            { day: 'Saturday', workout: 'Resistance', cal: 180, time: '10-11am', 
              details: '~35-40 min. Chest, shoulders, and core.',
              exercises: ['‚Äî Muscle Bending Bar ‚Äî', 'Front Chest Press 3x15 (hold 2 sec)', 'Overhead Press & Bend 3x12', 'Behind-the-Back Squeeze 3x15', 'Abdominal Crunch with Bar 3x15', 'Rotational Twists 3x10 each side', '‚Äî Bands & Bodyweight ‚Äî', 'Push-Ups 3x5-15', 'Band Pull-Aparts 3x20', 'Rapid Punches with Band 3x50', 'Cross Curls 3x12 each side', 'Band Chest Fly 3x15'] },
            { day: 'Sunday', workout: 'Rest Day', cal: 0, time: '', 
              details: 'Active recovery.',
              exercises: ['45-60 min walk', 'Stretching', 'Foam rolling (optional)'] },
        ];
        
        // Food database - loaded from FoodDB sheet, with fallback
        let ALL_FOODS = [
            { name: 'Baseline', cal: 78, protein: 1, sodium: 0, fiber: 0, sugar: 0, potassium: 0, calcium: 200, iron: 0, vitD: 400, magnesium: 100, icon: 'üìã' },
        ];
        
        // Load foods from FoodDB sheet
        async function loadFoodDB() {
            if (!accessToken) return;
            try {
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/FoodDB!A2:M200`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                if (!res.ok) return;
                const data = await res.json();
                if (!data.values || data.values.length === 0) return;
                
                // Parse sheet data: Name, Cal, Protein, Sodium, Fiber, Sugar, Potassium, Calcium, Iron, VitD, Magnesium, Icon, Short
                ALL_FOODS = data.values.map(row => ({
                    name: row[0] || '',
                    cal: parseInt(row[1]) || 0,
                    protein: parseInt(row[2]) || 0,
                    sodium: parseInt(row[3]) || 0,
                    fiber: parseInt(row[4]) || 0,
                    sugar: parseInt(row[5]) || 0,
                    potassium: parseInt(row[6]) || 0,
                    calcium: parseInt(row[7]) || 0,
                    iron: parseInt(row[8]) || 0,
                    vitD: parseInt(row[9]) || 0,
                    magnesium: parseInt(row[10]) || 0,
                    icon: row[11] || 'üçΩÔ∏è',
                    short: row[12] || ''
                })).filter(f => f.name); // Filter out empty rows
                
                console.log('Loaded ' + ALL_FOODS.length + ' foods from FoodDB');
                renderButtons(); // Re-render with new foods
            } catch (e) {
                console.error('Load FoodDB error:', e);
            }
        }
        
        const ALL_EXERCISES = [
            { name: 'Pilates', cal: 90, icon: 'üßò' },
            { name: 'Pilates Lesson', cal: 180, icon: 'üßò' },
            { name: 'Ab Circuit', cal: 200, icon: 'üí™' },
            { name: 'Bike', cal: 400, icon: 'üö¥' },
            { name: 'Resistance', cal: 180, icon: 'üèãÔ∏è' },
            { name: 'Long Walk', cal: 150, icon: 'üö∂', short: 'Walk' },
            { name: 'Drums 1hr', cal: 175, icon: 'ü•Å', short: 'Drums 1h' },
            { name: 'Drums 2hr', cal: 350, icon: 'ü•Å', short: 'Drums 2h' },
        ];
        
        // Usage tracking
        let itemUsage = JSON.parse(localStorage.getItem('hed_usage') || '{}');
        
        function trackUsage(name) {
            itemUsage[name] = (itemUsage[name] || 0) + 1;
            localStorage.setItem('hed_usage', JSON.stringify(itemUsage));
        }
        
        function seedUsageFromState() {
            // Count from today's entries
            state.entries.forEach(e => {
                itemUsage[e.name] = (itemUsage[e.name] || 0) + 1;
            });
            localStorage.setItem('hed_usage', JSON.stringify(itemUsage));
        }
        
        async function seedUsageFromSheets() {
            if (!accessToken) return;
            try {
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/DailyLog!H2:H100`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                if (res.status !== 200) return;
                
                const data = await res.json();
                if (!data.values) return;
                
                // Count item occurrences from Items column
                data.values.forEach(row => {
                    if (row[0]) {
                        row[0].split(', ').forEach(item => {
                            const name = item.trim();
                            if (name) {
                                itemUsage[name] = (itemUsage[name] || 0) + 1;
                            }
                        });
                    }
                });
                localStorage.setItem('hed_usage', JSON.stringify(itemUsage));
                renderButtons();
                console.log('Seeded usage from sheets:', itemUsage);
            } catch (e) {
                console.error('Seed usage error:', e);
            }
        }
        
        function renderButtons() {
            const quickEl = document.getElementById('foodButtonsQuick');
            const fullEl = document.getElementById('foodButtonsFull');
            const exEl = document.getElementById('exerciseButtons');
            if (!quickEl || !fullEl || !exEl) {
                console.error('Button containers not found');
                return;
            }
            
            // Helper to create nutrient object string for onclick
            const getNutrients = (f) => JSON.stringify({
                sodium: f.sodium || 0, fiber: f.fiber || 0, sugar: f.sugar || 0,
                potassium: f.potassium || 0, calcium: f.calcium || 0, iron: f.iron || 0,
                vitD: f.vitD || 0, magnesium: f.magnesium || 0
            }).replace(/"/g, "'");
            
            // Sort foods by usage (most used first)
            const sortedFoods = [...ALL_FOODS].sort((a, b) => (itemUsage[b.name] || 0) - (itemUsage[a.name] || 0));
            
            // Quick view - top 6 most used
            const quickFoods = sortedFoods.slice(0, 6);
            const quickHtml = quickFoods.map(f => 
                `<button class="qbtn food" onclick="addFoodByName('${f.name}')">${f.icon} ${f.short || f.name} <span class="qbtn-cal">${f.cal}/${f.protein}g/${f.sodium || 0}mg</span></button>`
            ).join('') + `<button class="qbtn food" onclick="openCustom()">‚ûï Custom</button>`;
            quickEl.innerHTML = quickHtml;
            
            // Full view - alphabetically sorted
            const alphaSorted = [...ALL_FOODS].sort((a, b) => a.name.localeCompare(b.name));
            const fullHtml = alphaSorted.map(f => 
                `<button class="qbtn food" onclick="addFoodByName('${f.name}')">${f.icon} ${f.short || f.name} <span class="qbtn-cal">${f.cal}/${f.protein}g/${f.sodium || 0}mg</span></button>`
            ).join('') + `<button class="qbtn food" onclick="openCustom()">‚ûï Custom</button>`;
            fullEl.innerHTML = fullHtml;
            
            // Sort exercises by usage
            const sortedEx = [...ALL_EXERCISES].sort((a, b) => (itemUsage[b.name] || 0) - (itemUsage[a.name] || 0));
            const exHtml = sortedEx.map(e => 
                `<button class="qbtn exercise" onclick="addExercise('${e.name}',${e.cal})">${e.icon} ${e.short || e.name} <span class="qbtn-cal">${e.cal}</span></button>`
            ).join('');
            exEl.innerHTML = exHtml;
        }
        
        // Helper to add food by name (looks up all nutrients)
        function addFoodByName(name) {
            const food = ALL_FOODS.find(f => f.name === name);
            if (food) {
                addFood(food.name, food.cal, food.protein, {
                    sodium: food.sodium || 0, fiber: food.fiber || 0, sugar: food.sugar || 0,
                    potassium: food.potassium || 0, calcium: food.calcium || 0, iron: food.iron || 0,
                    vitD: food.vitD || 0, magnesium: food.magnesium || 0
                });
            }
        }
        
        function toggleFoodList() {
            const quickEl = document.getElementById('foodButtonsQuick');
            const fullEl = document.getElementById('foodButtonsFull');
            const toggleEl = document.getElementById('foodToggle');
            showAllFoods = !showAllFoods;
            if (showAllFoods) {
                quickEl.style.display = 'none';
                fullEl.style.display = 'flex';
                toggleEl.textContent = 'Show Less ‚ñ≤';
            } else {
                quickEl.style.display = 'flex';
                fullEl.style.display = 'none';
                toggleEl.textContent = 'Show All ‚ñº';
            }
        }
        
        function updateSyncStatus() {
            const el = document.getElementById('syncStatus');
            if (accessToken) {
                el.textContent = 'MB';
                el.style.background = '#4CAF50';
                el.style.fontSize = '10px';
                el.style.fontWeight = 'bold';
                el.title = 'Signed in - tap to refresh token';
            } else {
                el.textContent = '';
                el.style.background = 'rgba(255,255,255,0.4)';
                el.title = 'Tap to sign in';
            }
        }
        
        // Handle 401 errors by clearing token and prompting re-auth
        function handleAuthError() {
            localStorage.removeItem('hed_token');
            accessToken = null;
            updateSyncStatus();
            toast('Session expired - tap MB to sign in');
        }
        
        // Wrapper for authenticated fetch that handles 401
        async function authFetch(url, options = {}) {
            if (!accessToken) return null;
            options.headers = { ...options.headers, Authorization: `Bearer ${accessToken}` };
            const res = await fetch(url, options);
            if (res.status === 401) {
                handleAuthError();
                return null;
            }
            return res;
        }
        
        // Init
        async function init() {
            state.date = new Date().toDateString();
            loadState();
            seedUsageFromState();
            updateUI();
            initGoogle();
            scheduleMidnightSave();
        }
        
        function initGoogle() {
            if (typeof google === 'undefined') {
                setTimeout(initGoogle, 200);
                return;
            }
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: async (r) => {
                    if (r.access_token) {
                        accessToken = r.access_token;
                        // Token expires in ~1 hour (3600 seconds)
                        tokenExpiry = Date.now() + (r.expires_in || 3600) * 1000;
                        localStorage.setItem('hed_token', accessToken);
                        localStorage.setItem('hed_token_expiry', tokenExpiry.toString());
                        document.getElementById('signInBtn').style.display = 'none';
                        updateSyncStatus();
                        // Load from Sheets after sign-in
                        const loaded = await loadFromLiveData();
                        if (loaded) {
                            updateUI();
                            toast('Synced from cloud!');
                        }
                        // Load food database from sheet
                        await loadFoodDB();
                        // Auto-sync any unsynced history to DailyLog
                        await syncHistoryToSheets(true);
                        seedUsageFromSheets();
                        syncSteps();
                    }
                }
            });
            
            // Check if we have a potentially valid token
            if (tokenLikelyValid()) {
                // Token looks valid, try to use it
                document.getElementById('signInBtn').style.display = 'none';
                loadFromLiveData().then(loaded => {
                    if (loaded) {
                        updateUI();
                        toast('Synced from cloud');
                    }
                });
                loadFoodDB(); // Load food database
                syncHistoryToSheets(true);
                seedUsageFromSheets();
            } else if (accessToken) {
                // Have a token but it's expired - show sign in button but don't auto-prompt
                document.getElementById('signInBtn').style.display = 'none';
                updateSyncStatus(); // Will show gray since token invalid
                console.log('Token expired - tap MB to sign in');
            } else {
                // No token at all
                document.getElementById('signInBtn').style.display = 'inline-flex';
            }
            updateSyncStatus();
        }
        
        function googleSignIn() { tokenClient.requestAccessToken(); }
        
        // State
        function loadState() {
            const today = new Date().toDateString();
            const saved = localStorage.getItem('hed_state');
            if (saved) {
                const parsed = JSON.parse(saved);
                if (parsed.date === today) {
                    state = parsed;
                } else {
                    saveToHistory(parsed);
                    saveToSheets(parsed);
                    state.date = today;
                }
            } else {
                state.date = today;
            }
        }
        
        function saveState() {
            state.date = new Date().toDateString();
            localStorage.setItem('hed_state', JSON.stringify(state));
            syncToLiveData(); // Sync to Sheets on every save
        }
        
        // Sync current state to LiveData sheet
        async function syncToLiveData() {
            await ensureValidToken();
            if (!accessToken) return;
            const today = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD format
            // Store entries with lastModified for proper sync
            const entriesData = JSON.stringify({
                entries: state.entries,
                lastModified: state.lastModified || Date.now()
            });
            const row = [today, state.calIn, state.protein, state.calOut, state.steps, state.calIn - state.calOut, state.workout ? 'Yes' : 'No', entriesData];
            try {
                await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/LiveData!A2:H2?valueInputOption=RAW`, {
                    method: 'PUT',
                    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: [row] })
                });
                console.log('Synced to LiveData');
            } catch (e) { 
                console.error('LiveData sync error:', e); 
            }
        }
        
        // Load state from LiveData sheet
        async function loadFromLiveData() {
            await ensureValidToken();
            if (!accessToken) return false;
            try {
                // First ensure headers exist
                await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/LiveData!A1:H1?valueInputOption=RAW`, {
                    method: 'PUT',
                    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: [['Date', 'Cal In', 'Protein', 'Cal Out', 'Steps', 'Net', 'Workout', 'Entries']] })
                });
                
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/LiveData!A2:H2`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                
                if (res.status === 401) {
                    handleAuthError();
                    return false;
                }
                
                const data = await res.json();
                const today = new Date().toLocaleDateString('en-CA');
                
                if (data.values && data.values[0] && data.values[0][0] === today) {
                    // Sheet has today's data - compare with local
                    const row = data.values[0];
                    const sheetCalIn = parseInt(row[1]) || 0;
                    let sheetEntries = [];
                    let sheetLastModified = 0;
                    try { 
                        const parsed = JSON.parse(row[7] || '[]');
                        // Check if it's the new format with lastModified
                        if (parsed.lastModified) {
                            sheetEntries = parsed.entries || [];
                            sheetLastModified = parsed.lastModified || 0;
                        } else {
                            // Old format - just entries array
                            sheetEntries = parsed;
                        }
                    } catch { 
                        sheetEntries = []; 
                    }
                    
                    // Get most recent timestamp from each (including lastModified for deletions)
                    const getLatestTime = (entries, lastMod = 0) => {
                        let latest = lastMod;
                        if (entries && entries.length) {
                            const entryMax = Math.max(...entries.map(e => e.time || 0));
                            latest = Math.max(latest, entryMax);
                        }
                        return latest;
                    };
                    
                    const localLatest = getLatestTime(state.entries, state.lastModified || 0);
                    const sheetLatest = getLatestTime(sheetEntries, sheetLastModified);
                    const sheetWorkout = row[6] === 'Yes';
                    
                    console.log('Merge check - Local latest:', localLatest, 'Sheet latest:', sheetLatest);
                    
                    // Preserve workout flag if either has it true
                    if (sheetWorkout && !state.workout) {
                        state.workout = true;
                        console.log('Preserving workout flag from sheet');
                    }
                    
                    // Use the one with the most recent modification
                    if (localLatest > sheetLatest) {
                        console.log('Local has newer data, syncing to sheet');
                        await syncToLiveData();
                        return false;
                    }
                    
                    // Sheet has newer data, load it
                    if (sheetLatest > 0) {
                        // Preserve local workout flag if true
                        const preserveWorkout = state.workout || sheetWorkout;
                        
                        state.date = new Date().toDateString();
                        state.calIn = sheetCalIn;
                        state.protein = parseInt(row[2]) || 0;
                        state.calOut = parseInt(row[3]) || 0;
                        state.steps = parseInt(row[4]) || 0;
                        state.workout = preserveWorkout;
                        state.entries = sheetEntries;
                        state.lastModified = sheetLastModified;
                        localStorage.setItem('hed_state', JSON.stringify(state));
                        console.log('Loaded from LiveData:', state);
                        return true;
                    }
                    return false;
                } else if (data.values && data.values[0] && data.values[0][0]) {
                    // Different day - archive old data, but keep local state
                    console.log('New day detected, archiving old LiveData');
                    await archiveToDaily(data.values[0]);
                    // Clear LiveData row (will be filled by syncToLiveData when user adds items)
                    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/LiveData!A2:H2:clear`, {
                        method: 'POST',
                        headers: { Authorization: `Bearer ${accessToken}` }
                    });
                    // Sync current local state to LiveData
                    if (state.entries.length > 0) {
                        await syncToLiveData();
                    }
                } else {
                    // No data in sheet for today - sync local to sheet
                    if (state.entries.length > 0) {
                        console.log('Sheet empty, syncing local to sheet');
                        await syncToLiveData();
                    }
                }
                // No data for today in sheet - keep local state, don't overwrite
                return false;
            } catch (e) { 
                console.error('LoadFromLiveData error:', e);
                return false; 
            }
        }
        
        // Archive a day's data to DailyLog
        async function archiveToDaily(row) {
            if (!accessToken) return;
            try {
                // Normalize date function
                const normalizeDate = (d) => {
                    if (!d) return '';
                    if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
                    try {
                        const parsed = new Date(d);
                        if (!isNaN(parsed.getTime())) return parsed.toISOString().split('T')[0];
                    } catch {}
                    return d;
                };
                
                // Check if date already exists in DailyLog
                const checkRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/DailyLog!A:A`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                const checkData = await checkRes.json();
                const existingDates = new Set((checkData.values || []).flat().map(normalizeDate));
                const rowDate = normalizeDate(row[0]);
                
                if (existingDates.has(rowDate)) {
                    console.log('Date already archived:', rowDate);
                    return;
                }
                
                // Ensure headers
                await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/DailyLog!A1:H1?valueInputOption=RAW`, {
                    method: 'PUT',
                    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: [['Date', 'Cal In', 'Protein', 'Cal Out', 'Steps', 'Net', 'Workout', 'Items']] })
                });
                
                // Convert entries JSON to item names
                let items = '';
                try {
                    const entries = JSON.parse(row[7] || '[]');
                    items = entries.map(e => e.name).join(', ');
                } catch {}
                
                const archiveRow = [rowDate, row[1], row[2], row[3], row[4], row[5], row[6], items];
                
                await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/DailyLog!A:H:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS`, {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: [archiveRow] })
                });
                console.log('Archived to DailyLog:', rowDate);
            } catch (e) {
                console.error('Archive error:', e);
            }
        }
        
        // Manual refresh button
        async function refreshFromSheets() {
            toast('Refreshing...');
            const loaded = await loadFromLiveData();
            if (loaded) {
                updateUI();
                toast('Synced from cloud!');
            } else {
                toast('No cloud data or not signed in');
            }
        }
        
        // Sync local history to DailyLog sheet
        async function syncHistoryToSheets(silent = false) {
            if (!accessToken) { 
                if (!silent) toast('Please sign in first');
                return; 
            }
            if (!silent) toast('Syncing history...');
            const history = JSON.parse(localStorage.getItem('hed_history') || '[]');
            if (!history.length) {
                if (!silent) toast('No history to sync');
                return;
            }
            
            try {
                // Get existing dates in DailyLog
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/DailyLog!A:A`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                const data = await res.json();
                
                // Normalize all dates to YYYY-MM-DD for comparison
                const normalizeDate = (d) => {
                    if (!d) return '';
                    if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
                    try {
                        const parsed = new Date(d);
                        if (!isNaN(parsed.getTime())) return parsed.toISOString().split('T')[0];
                    } catch {}
                    return d;
                };
                
                const existingDates = new Set((data.values || []).flat().map(normalizeDate));
                
                // Filter history to only new dates (normalize for comparison)
                const newEntries = history.filter(h => {
                    const normDate = normalizeDate(h.date);
                    // Skip if no date or already exists
                    if (!normDate || existingDates.has(normDate)) return false;
                    // Skip if no actual data
                    if (!h.calIn && !h.protein) return false;
                    return true;
                });
                
                if (!newEntries.length) {
                    if (!silent) toast('History already synced');
                    return;
                }
                
                // Append new entries with normalized dates
                const rows = newEntries.map(h => [
                    normalizeDate(h.date), h.calIn || 0, h.protein || 0, h.calOut || 0, h.steps || 0, 
                    (h.calIn || 0) - (h.calOut || 0), h.workout ? 'Yes' : 'No', ''
                ]);
                
                await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/DailyLog!A:H:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS`, {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: rows })
                });
                
                if (!silent) toast(`Synced ${newEntries.length} day(s) to Sheets`);
                console.log(`Auto-synced ${newEntries.length} day(s) to DailyLog`);
            } catch (e) {
                console.error('Sync history error:', e);
                if (!silent) toast('Sync failed');
            }
        }
        
        function saveToHistory(data) {
            if (!data.calIn && !data.entries.length) return;
            let history = JSON.parse(localStorage.getItem('hed_history') || '[]');
            const weightHistory = JSON.parse(localStorage.getItem('hed_weight_history') || '[]');
            
            // Normalize date function
            const normalizeDate = (d) => {
                if (!d) return new Date().toLocaleDateString('en-CA');
                if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
                try {
                    const parsed = new Date(d);
                    if (!isNaN(parsed.getTime())) return parsed.toISOString().split('T')[0];
                } catch {}
                return new Date().toLocaleDateString('en-CA');
            };
            
            // Use the data's date, normalized to YYYY-MM-DD
            const dateStr = normalizeDate(data.date);
            
            // Get weight for this date (first weight of day)
            const dayWeight = weightHistory.find(w => w.date === dateStr);
            
            // Build history entry with entries array for detail view
            const historyEntry = { 
                date: dateStr, 
                calIn: data.calIn, 
                calOut: data.calOut, 
                protein: data.protein, 
                sodium: data.sodium || 0,
                steps: data.steps, 
                workout: data.workout,
                weight: dayWeight ? dayWeight.weight : null,
                entries: data.entries || []
            };
            
            // Check if this date already exists in history
            const existingIndex = history.findIndex(h => normalizeDate(h.date) === dateStr);
            if (existingIndex >= 0) {
                // Update existing entry
                history[existingIndex] = historyEntry;
            } else {
                // Add new entry
                history.unshift(historyEntry);
            }
            localStorage.setItem('hed_history', JSON.stringify(history.slice(0, 30)));
        }
        
        async function saveToSheets(data) {
            if (!accessToken || (!data.calIn && !data.entries.length)) return;
            const row = [data.date, data.calIn, data.protein, data.calOut, data.steps, data.calIn - data.calOut, data.workout ? 'Yes' : 'No', data.entries.map(e => e.name).join(', ')];
            try {
                const check = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/A1`, { headers: { Authorization: `Bearer ${accessToken}` } });
                const checkData = await check.json();
                if (!checkData.values) {
                    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/A1:H1?valueInputOption=RAW`, {
                        method: 'PUT',
                        headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ values: [['Date', 'Cal In', 'Protein', 'Cal Out', 'Steps', 'Net', 'Workout', 'Items']] })
                    });
                }
                await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/A:H:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS`, {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: [row] })
                });
            } catch (e) { console.error(e); }
        }
        
        function scheduleMidnightSave() {
            const now = new Date();
            const midnight = new Date(now);
            midnight.setHours(24, 0, 0, 0);
            const ms = midnight - now;
            setTimeout(() => {
                saveToHistory(state);
                saveToSheets(state);
                state = { 
                    date: new Date().toDateString(), calIn: 0, calOut: 0, protein: 0, 
                    sodium: 0, fiber: 0, sugar: 0, potassium: 0, calcium: 0, iron: 0, vitD: 0, magnesium: 0,
                    steps: 0, workout: false, entries: [] 
                };
                saveState();
                updateUI();
                scheduleMidnightSave();
            }, ms);
        }
        
        // UI
        function updateUI() {
            document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            document.getElementById('calIn').textContent = state.calIn;
            document.getElementById('protein').textContent = state.protein + 'g';
            document.getElementById('burned').textContent = state.calOut;
            const net = state.calIn - state.calOut;
            document.getElementById('net').textContent = net;
            
            const calPct = Math.min(Math.round((net / TARGETS.cal) * 100), 100);
            const worPct = Math.min(Math.round((state.protein / TARGETS.protein) * 100), 100);
            const sodiumPct = Math.min(Math.round(((state.sodium || 0) / TARGETS.sodium) * 100), 100);
            document.getElementById('calPct').textContent = calPct;
            document.getElementById('worPct').textContent = worPct;
            document.getElementById('sodiumPct').textContent = sodiumPct;
            document.getElementById('calBar').style.width = calPct + '%';
            document.getElementById('worBar').style.width = worPct + '%';
            document.getElementById('sodiumBar').style.width = sodiumPct + '%';
            
            // Goals section
            document.getElementById('goalCal').textContent = net + '/1600';
            document.getElementById('goalProtein').textContent = state.protein + '/110g';
            document.getElementById('goalSodium').textContent = (state.sodium || 0) + '/2300mg';
            document.getElementById('goalSteps').textContent = state.steps.toLocaleString() + '/7500';
            
            // Workout button
            const workoutBtn = document.getElementById('workoutBtn');
            workoutBtn.textContent = state.workout ? '‚òë Workout Done' : '‚òê Workout Done';
            workoutBtn.className = state.workout ? 'workout-btn done' : 'workout-btn';
            
            // Weight display in Summary section
            const weight = localStorage.getItem('hed_weight') || '--';
            document.getElementById('weightDisplay').textContent = weight + 'kg';
            
            // Today's nutrients in Summary
            document.getElementById('fiberToday').textContent = (state.fiber || 0) + '/' + TARGETS.fiber + 'g';
            document.getElementById('sugarToday').textContent = (state.sugar || 0) + '/' + TARGETS.sugar + 'g';
            document.getElementById('potassiumToday').textContent = (state.potassium || 0) + '/' + TARGETS.potassium + 'mg';
            document.getElementById('calciumToday').textContent = (state.calcium || 0) + '/' + TARGETS.calcium + 'mg';
            document.getElementById('ironToday').textContent = (state.iron || 0) + '/' + TARGETS.iron + 'mg';
            document.getElementById('vitDToday').textContent = (state.vitD || 0) + '/' + TARGETS.vitD + 'IU';
            document.getElementById('magnesiumToday').textContent = (state.magnesium || 0) + '/' + TARGETS.magnesium + 'mg';
            
            // Update nutrition summary
            updateNutritionSummary();
            
            renderLog();
            renderHistory();
            renderPlan();
            renderButtons();
        }
        
        function updateNutritionSummary() {
            const history = JSON.parse(localStorage.getItem('hed_history') || '[]');
            const weightHistory = JSON.parse(localStorage.getItem('hed_weight_history') || '[]');
            
            // Weight trend (last 7 days)
            if (weightHistory.length >= 2) {
                const recent = weightHistory.slice(0, 7);
                const oldest = recent[recent.length - 1]?.weight || 0;
                const newest = recent[0]?.weight || 0;
                const diff = (newest - oldest).toFixed(1);
                const trend = diff > 0 ? `+${diff}kg ‚Üë` : diff < 0 ? `${diff}kg ‚Üì` : '0kg ‚Üí';
                document.getElementById('weightTrend').textContent = trend;
                document.getElementById('weightTrend').style.color = diff <= 0 ? '#4CAF50' : '#f44336';
            } else {
                document.getElementById('weightTrend').textContent = 'Need more data';
            }
            
            // Average daily deficit (last 7 days)
            if (history.length > 0) {
                const recent = history.slice(0, 7);
                const avgDeficit = Math.round(recent.reduce((sum, d) => sum + (d.calIn - d.calOut), 0) / recent.length);
                document.getElementById('avgDeficit').textContent = avgDeficit + ' cal/day';
                document.getElementById('avgDeficit').style.color = avgDeficit <= 1600 ? '#4CAF50' : '#f44336';
                
                // Protein average
                const avgProtein = Math.round(recent.reduce((sum, d) => sum + d.protein, 0) / recent.length);
                document.getElementById('proteinAvg').textContent = avgProtein + 'g/day';
                document.getElementById('proteinAvg').style.color = avgProtein >= 100 ? '#4CAF50' : '#f44336';
                
                // Workout streak
                let streak = 0;
                for (const d of recent) {
                    if (d.workout) streak++;
                    else break;
                }
                document.getElementById('workoutStreak').textContent = streak + ' days';
            } else {
                document.getElementById('avgDeficit').textContent = 'No data';
                document.getElementById('proteinAvg').textContent = 'No data';
                document.getElementById('workoutStreak').textContent = '0 days';
            }
        }
        
        function renderPlan() {
            const todayName = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            const list = document.getElementById('planList');
            if (!list) return;
            
            list.innerHTML = WEEKLY_PLAN.map((p, i) => `
                <div class="summary-card" style="${p.day === todayName ? 'border-left: 4px solid #667eea; background: #f8f9ff;' : ''}">
                    <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;" onclick="togglePlanDay(${i})">
                        <span style="font-weight:600;font-size:13px;">${p.day}${p.day === todayName ? ' (TODAY)' : ''}</span>
                        <span style="font-size:11px;color:#666;">${p.time} <span id="planArrow${i}">‚ñ∂</span></span>
                    </div>
                    <div style="font-size:12px;color:#333;margin-top:6px;">üí™ ${p.workout} ${p.cal ? `(${p.cal} cal)` : ''}</div>
                    <div style="font-size:11px;color:#666;margin-top:4px;">${p.details}</div>
                    <div id="planExercises${i}" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid #eee;">
                        ${p.exercises.map((ex, j) => {
                            const hint = EXERCISE_HINTS[ex];
                            const isHeader = ex.startsWith('‚Äî');
                            if (isHeader) {
                                return `<div style="font-size:11px;color:#667eea;font-weight:600;padding:8px 0 4px 0;">${ex}</div>`;
                            }
                            return `<div style="font-size:11px;color:#444;padding:3px 0;">
                                <div style="display:flex;justify-content:space-between;align-items:center;cursor:${hint ? 'pointer' : 'default'};" onclick="${hint ? `toggleExHint(${i},${j})` : ''}">
                                    <span>‚Ä¢ ${ex}</span>
                                    ${hint ? `<span id="exArrow${i}_${j}" style="color:#999;font-size:10px;">‚ÑπÔ∏è</span>` : ''}
                                </div>
                                ${hint ? `<div id="exHint${i}_${j}" style="display:none;font-size:10px;color:#888;padding:4px 0 4px 12px;font-style:italic;">‚Üí ${hint}</div>` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        function togglePlanDay(i) {
            const el = document.getElementById('planExercises' + i);
            const arrow = document.getElementById('planArrow' + i);
            if (el.style.display === 'none') {
                el.style.display = 'block';
                arrow.textContent = '‚ñº';
            } else {
                el.style.display = 'none';
                arrow.textContent = '‚ñ∂';
            }
        }
        
        function toggleExHint(dayIdx, exIdx) {
            const el = document.getElementById(`exHint${dayIdx}_${exIdx}`);
            if (el) {
                el.style.display = el.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function renderLog() {
            const list = document.getElementById('logList');
            if (!state.entries.length) {
                list.innerHTML = '<div class="no-entries">No entries yet</div>';
                return;
            }
            list.innerHTML = state.entries.map((e, i) => `
                <div class="summary-item">
                    <div class="item-left">
                        <div class="item-dot ${e.type}"></div>
                        <span class="item-name">${e.name}</span>
                    </div>
                    <span class="item-values">${e.type === 'food' ? e.cal + '/' + e.protein + 'g' + (e.sodium ? '/' + e.sodium + 'mg' : '') : e.cal + ' cal'}</span>
                    <button class="item-delete" onclick="deleteEntry(${i})">√ó</button>
                </div>
            `).join('');
        }
        
        function renderHistory() {
            // First show local history - auto dedupe by normalized date
            let history = JSON.parse(localStorage.getItem('hed_history') || '[]');
            const weightHistory = JSON.parse(localStorage.getItem('hed_weight_history') || '[]');
            
            // Normalize and dedupe
            const normalizeDate = (d) => {
                if (!d) return '';
                if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
                try {
                    const parsed = new Date(d);
                    if (!isNaN(parsed.getTime())) return parsed.toISOString().split('T')[0];
                } catch {}
                return d;
            };
            
            // Create weight lookup by date
            const weightByDate = {};
            weightHistory.forEach(w => { weightByDate[w.date] = w.weight; });
            
            const seen = new Set();
            history = history.filter(h => {
                const norm = normalizeDate(h.date);
                if (seen.has(norm)) return false;
                seen.add(norm);
                h.date = norm; // Normalize the date
                // Add weight from weightHistory if available
                if (weightByDate[norm]) {
                    h.weight = weightByDate[norm];
                }
                return true;
            });
            localStorage.setItem('hed_history', JSON.stringify(history));
            
            const list = document.getElementById('historyList');
            if (!history.length) {
                list.innerHTML = '<div class="no-entries">No history yet</div>';
            } else {
                list.innerHTML = history.map((d, i) => `
                    <div class="history-card">
                        <div class="history-date" onclick="toggleHistoryDetail(${i})" style="cursor:pointer;">
                            <span>${d.date} ${d.weight ? '<span style="color:#667eea;">‚öñÔ∏è' + d.weight + 'kg</span>' : ''}</span>
                            <span>${d.workout ? '‚úÖ' : '‚¨ú'} <span id="histArrowLocal${i}">‚ñ∂</span></span>
                        </div>
                        <div class="history-stats">
                            <div class="history-stat ${d.calIn <= TARGETS.cal ? 'good' : 'bad'}"><div class="history-stat-value">${d.calIn}</div><div class="history-stat-label">Cal In</div></div>
                            <div class="history-stat ${d.protein >= TARGETS.protein ? 'good' : ''}"><div class="history-stat-value">${d.protein}g</div><div class="history-stat-label">Protein</div></div>
                            <div class="history-stat"><div class="history-stat-value">${d.calOut}</div><div class="history-stat-label">Burned</div></div>
                            <div class="history-stat"><div class="history-stat-value">${(d.steps||0).toLocaleString()}</div><div class="history-stat-label">Steps</div></div>
                        </div>
                        <div id="histDetailLocal${i}" style="display:none;padding:10px 0;border-top:1px solid #eee;margin-top:8px;font-size:11px;">
                            ${d.entries && d.entries.length > 0 ? d.entries.map(e => 
                                `<div style="display:flex;justify-content:space-between;padding:2px 0;">
                                    <span>${e.type === 'food' ? 'üçΩÔ∏è' : 'üí™'} ${e.name}</span>
                                    <span>${e.type === 'food' ? e.cal + 'cal / ' + e.protein + 'g' : e.cal + ' burned'}</span>
                                </div>`
                            ).join('') : '<div style="color:#999;">No detailed entries</div>'}
                        </div>
                        <button onclick="deleteHistoryItem(${i})" style="position:absolute;top:8px;right:8px;background:none;border:none;color:#ccc;font-size:14px;cursor:pointer;">√ó</button>
                    </div>
                `).join('');
            }
            
            // Then try to load from Sheets if we don't have much local history
            if (history.length < 5 && accessToken) {
                loadHistoryFromSheets();
            }
        }
        
        function toggleHistoryDetail(i) {
            // Try both local and sheet detail elements
            let el = document.getElementById('histDetailLocal' + i);
            let arrow = document.getElementById('histArrowLocal' + i);
            if (!el) {
                el = document.getElementById('histDetail' + i);
                arrow = document.getElementById('histArrow' + i);
            }
            if (!el) return;
            
            if (el.style.display === 'none') {
                el.style.display = 'block';
                if (arrow) arrow.textContent = '‚ñº';
            } else {
                el.style.display = 'none';
                if (arrow) arrow.textContent = '‚ñ∂';
            }
        }
        
        async function loadHistoryFromSheets() {
            if (!accessToken) return;
            try {
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/DailyLog!A2:H100`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                if (res.status !== 200) return;
                
                const data = await res.json();
                if (!data.values || !data.values.length) return;
                
                // Normalize date function
                const normalizeDate = (d) => {
                    if (!d) return '';
                    if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
                    try {
                        const parsed = new Date(d);
                        if (!isNaN(parsed.getTime())) return parsed.toISOString().split('T')[0];
                    } catch {}
                    return d;
                };
                
                // Convert sheet rows to history format, dedupe by normalized date
                const seenDates = new Set();
                const sheetHistory = [];
                data.values.forEach(row => {
                    const rawDate = row[0];
                    const date = normalizeDate(rawDate);
                    if (date && !seenDates.has(date)) {
                        seenDates.add(date);
                        sheetHistory.push({
                            date: date,
                            calIn: parseInt(row[1]) || 0,
                            protein: parseInt(row[2]) || 0,
                            calOut: parseInt(row[3]) || 0,
                            steps: parseInt(row[4]) || 0,
                            workout: row[6] === 'Yes'
                        });
                    }
                });
                
                // Merge with local history (dedupe by normalized date)
                const localHistory = JSON.parse(localStorage.getItem('hed_history') || '[]');
                localHistory.forEach(h => {
                    const normDate = normalizeDate(h.date);
                    if (!seenDates.has(normDate)) {
                        seenDates.add(normDate);
                        h.date = normDate;
                        sheetHistory.push(h);
                    }
                });
                
                // Sort by date descending
                sheetHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Merge weight history
                const weightHistory = JSON.parse(localStorage.getItem('hed_weight_history') || '[]');
                const weightByDate = {};
                weightHistory.forEach(w => { weightByDate[w.date] = w.weight; });
                sheetHistory.forEach(h => {
                    if (weightByDate[h.date]) {
                        h.weight = weightByDate[h.date];
                    }
                });
                
                // Save and render
                localStorage.setItem('hed_history', JSON.stringify(sheetHistory.slice(0, 30)));
                
                // Re-render
                const list = document.getElementById('historyList');
                if (sheetHistory.length === 0) {
                    list.innerHTML = '<div class="no-entries">No history yet</div>';
                    return;
                }
                list.innerHTML = sheetHistory.slice(0, 30).map((d, i) => `
                    <div class="history-card">
                        <div class="history-date" onclick="toggleHistoryDetail(${i})" style="cursor:pointer;">
                            <span>${d.date} ${d.weight ? '‚öñÔ∏è' + d.weight + 'kg' : ''}</span>
                            <span>${d.workout ? '‚úÖ' : '‚¨ú'} <span id="histArrow${i}">‚ñ∂</span></span>
                        </div>
                        <div class="history-stats">
                            <div class="history-stat ${d.calIn <= TARGETS.cal ? 'good' : 'bad'}"><div class="history-stat-value">${d.calIn}</div><div class="history-stat-label">Cal In</div></div>
                            <div class="history-stat ${d.protein >= TARGETS.protein ? 'good' : ''}"><div class="history-stat-value">${d.protein}g</div><div class="history-stat-label">Protein</div></div>
                            <div class="history-stat"><div class="history-stat-value">${d.calOut}</div><div class="history-stat-label">Burned</div></div>
                            <div class="history-stat"><div class="history-stat-value">${(d.steps||0).toLocaleString()}</div><div class="history-stat-label">Steps</div></div>
                        </div>
                        <div id="histDetail${i}" style="display:none;padding:10px 0;border-top:1px solid #eee;margin-top:8px;font-size:11px;">
                            ${d.entries && d.entries.length > 0 ? d.entries.map(e => 
                                `<div style="display:flex;justify-content:space-between;padding:2px 0;">
                                    <span>${e.type === 'food' ? 'üçΩÔ∏è' : 'üí™'} ${e.name}</span>
                                    <span>${e.type === 'food' ? e.cal + 'cal / ' + e.protein + 'g' : e.cal + ' burned'}</span>
                                </div>`
                            ).join('') : '<div style="color:#999;">No detailed entries</div>'}
                            <div style="margin-top:8px;text-align:right;">
                                <button onclick="deleteHistoryItem(${i})" style="background:#ff6b6b;color:white;border:none;padding:4px 8px;border-radius:4px;font-size:10px;cursor:pointer;">Delete Day</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Load history error:', e);
            }
        }
        
        function updateNutritionSummary() {
            const history = JSON.parse(localStorage.getItem('hed_history') || '[]');
            const weightHistory = JSON.parse(localStorage.getItem('hed_weight_history') || '[]');
            
            // Weight trend (last 7 days)
            if (weightHistory.length >= 2) {
                const recent = weightHistory.slice(0, 7);
                const first = recent[recent.length - 1].weight;
                const last = recent[0].weight;
                const diff = (last - first).toFixed(1);
                const trend = diff > 0 ? `+${diff}kg ‚Üë` : `${diff}kg ‚Üì`;
                document.getElementById('weightTrend').textContent = trend;
                document.getElementById('weightTrend').style.color = diff <= 0 ? '#4CAF50' : '#ff6b6b';
            } else {
                document.getElementById('weightTrend').textContent = 'Need more data';
            }
            
            // Average deficit (last 7 days)
            if (history.length > 0) {
                const recent = history.slice(0, 7);
                const avgDeficit = Math.round(recent.reduce((sum, d) => sum + (TARGETS.cal - (d.calIn - d.calOut)), 0) / recent.length);
                document.getElementById('avgDeficit').textContent = avgDeficit > 0 ? `-${avgDeficit} cal` : `+${Math.abs(avgDeficit)} cal`;
                document.getElementById('avgDeficit').style.color = avgDeficit > 0 ? '#4CAF50' : '#ff6b6b';
                
                // Protein average
                const avgProtein = Math.round(recent.reduce((sum, d) => sum + d.protein, 0) / recent.length);
                document.getElementById('proteinAvg').textContent = avgProtein + 'g';
                document.getElementById('proteinAvg').style.color = avgProtein >= TARGETS.protein ? '#4CAF50' : '#ff6b6b';
                
                // Workout streak
                let streak = 0;
                for (const d of history) {
                    if (d.workout) streak++;
                    else break;
                }
                document.getElementById('workoutStreak').textContent = streak + ' days';
            }
        }
        
        function deleteHistoryItem(index) {
            let history = JSON.parse(localStorage.getItem('hed_history') || '[]');
            if (index >= 0 && index < history.length) {
                history.splice(index, 1);
                localStorage.setItem('hed_history', JSON.stringify(history));
                renderHistory();
                toast('Deleted from history');
            }
        }
        
        function showPane(name) {
            // Remove active from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            // Remove active from all panes
            const panes = document.querySelectorAll('.pane');
            panes.forEach(p => p.classList.remove('active'));
            
            // Add active to selected tab
            if (name === 'today') tabs[0].classList.add('active');
            else if (name === 'add') tabs[1].classList.add('active');
            else if (name === 'plan') tabs[2].classList.add('active');
            else if (name === 'history') tabs[3].classList.add('active');
            
            // Add active to selected pane
            const pane = document.getElementById(name + 'Pane');
            if (pane) pane.classList.add('active');
        }
        
        function toast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
        
        // Actions
        function addFood(name, cal, protein, nutrients = {}) {
            state.calIn += cal;
            state.protein += protein;
            state.sodium = (state.sodium || 0) + (nutrients.sodium || 0);
            state.fiber = (state.fiber || 0) + (nutrients.fiber || 0);
            state.sugar = (state.sugar || 0) + (nutrients.sugar || 0);
            state.potassium = (state.potassium || 0) + (nutrients.potassium || 0);
            state.calcium = (state.calcium || 0) + (nutrients.calcium || 0);
            state.iron = (state.iron || 0) + (nutrients.iron || 0);
            state.vitD = (state.vitD || 0) + (nutrients.vitD || 0);
            state.magnesium = (state.magnesium || 0) + (nutrients.magnesium || 0);
            state.entries.push({ type: 'food', name, cal, protein, ...nutrients, time: Date.now() });
            trackUsage(name);
            saveState();
            updateUI();
            toast('Added ' + name);
        }
        
        function addExercise(name, cal) {
            state.calOut += cal;
            state.entries.push({ type: 'exercise', name, cal, time: Date.now() });
            trackUsage(name);
            saveState();
            updateUI();
            toast('Added ' + name);
        }
        
        function deleteEntry(i) {
            const e = state.entries[i];
            if (e.type === 'food') {
                state.calIn -= e.cal;
                state.protein -= e.protein;
            } else {
                state.calOut -= e.cal;
                if (e.steps) state.steps = 0;
            }
            state.entries.splice(i, 1);
            state.lastModified = Date.now(); // Track deletion time
            saveState();
            updateUI();
            toast('Deleted ' + e.name);
        }
        
        function toggleWorkout() {
            state.workout = !state.workout;
            saveState();
            updateUI();
            toast(state.workout ? 'Workout done! üí™' : 'Workout unmarked');
        }
        
        // Steps
        async function syncSteps() {
            await ensureValidToken();
            if (!accessToken) { googleSignIn(); return; }
            toast('Syncing steps...');
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            try {
                const res = await fetch('https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate', {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        aggregateBy: [{ dataTypeName: 'com.google.step_count.delta', dataSourceId: 'derived:com.google.step_count.delta:com.google.android.gms:estimated_steps' }],
                        bucketByTime: { durationMillis: 86400000 },
                        startTimeMillis: start,
                        endTimeMillis: now.getTime()
                    })
                });
                if (res.status === 401) {
                    handleAuthError();
                    return;
                }
                const data = await res.json();
                let steps = 0;
                data.bucket?.forEach(b => b.dataset?.forEach(d => d.point?.forEach(p => { steps += p.value?.[0]?.intVal || 0; })));
                
                const oldCal = Math.round(state.steps * 0.04);
                const newCal = Math.round(steps * 0.04);
                state.calOut = state.calOut - oldCal + newCal;
                state.steps = steps;
                
                const idx = state.entries.findIndex(e => e.name?.includes('Steps'));
                if (idx >= 0) state.entries[idx] = { type: 'exercise', name: 'Steps (Synced)', cal: newCal, steps, time: Date.now() };
                else state.entries.push({ type: 'exercise', name: 'Steps (Synced)', cal: newCal, steps, time: Date.now() });
                
                saveState();
                updateUI();
                toast(steps.toLocaleString() + ' steps synced');
            } catch (e) {
                console.error(e);
                toast('Sync failed');
            }
        }
        
        function saveManualSteps() {
            const steps = parseInt(document.getElementById('stepsInput').value) || 0;
            const oldCal = Math.round(state.steps * 0.04);
            const newCal = Math.round(steps * 0.04);
            state.calOut = state.calOut - oldCal + newCal;
            state.steps = steps;
            
            const idx = state.entries.findIndex(e => e.name?.includes('Steps'));
            if (idx >= 0) state.entries[idx] = { type: 'exercise', name: 'Steps (Manual)', cal: newCal, steps, time: Date.now() };
            else state.entries.push({ type: 'exercise', name: 'Steps (Manual)', cal: newCal, steps, time: Date.now() });
            
            saveState();
            updateUI();
            closeModal('stepsModal');
            showPane('today');
            toast(steps.toLocaleString() + ' steps logged');
        }
        
        // Photo
        function takePhoto() { document.getElementById('cameraInput').click(); }
        function uploadPhoto() { document.getElementById('photoInput').click(); }
        
        function handlePhoto(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                photoData = ev.target.result;
                document.getElementById('photoPreview').src = photoData;
                document.getElementById('photoPreview').style.display = 'block';
                document.getElementById('photoModal').classList.add('open');
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }
        
        function savePhoto() {
            const name = document.getElementById('photoName').value || 'Meal';
            const cal = parseInt(document.getElementById('photoCal').value) || 0;
            const protein = parseInt(document.getElementById('photoPro').value) || 0;
            state.calIn += cal;
            state.protein += protein;
            state.entries.push({ type: 'food', name, cal, protein, photo: photoData, time: Date.now() });
            saveState();
            updateUI();
            closeModal('photoModal');
            document.getElementById('photoName').value = '';
            document.getElementById('photoCal').value = '';
            document.getElementById('photoPro').value = '';
            photoData = null;
            showPane('today');
            toast('Added ' + name);
        }
        
        // Custom
        function openCustom() { document.getElementById('customModal').classList.add('open'); }
        
        function saveCustom() {
            const name = document.getElementById('customName').value || 'Custom';
            const cal = parseInt(document.getElementById('customCal').value) || 0;
            const protein = parseInt(document.getElementById('customPro').value) || 0;
            addFood(name, cal, protein);
            closeModal('customModal');
            document.getElementById('customName').value = '';
            document.getElementById('customCal').value = '';
            document.getElementById('customPro').value = '';
        }
        
        function promptWeight() {
            const weight = prompt('Enter weight in kg:', localStorage.getItem('hed_weight') || '');
            if (weight && !isNaN(parseFloat(weight))) {
                localStorage.setItem('hed_weight', parseFloat(weight).toFixed(1));
                localStorage.setItem('hed_weight_date', new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                updateUI();
                toast('Weight logged: ' + weight + 'kg');
            }
        }
        
        async function syncWeight() {
            if (!accessToken) { googleSignIn(); return; }
            toast('Syncing weight...');
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate()).getTime(); // Last 30 days
            try {
                const res = await fetch('https://www.googleapis.com/fitness/v1/users/me/dataSources/derived:com.google.weight:com.google.android.gms:merge_weight/datasets/' + start + '000000-' + now.getTime() + '000000', {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                if (res.status === 401) {
                    toast('Please sign in again');
                    return;
                }
                const data = await res.json();
                if (data.point && data.point.length > 0) {
                    // Get most recent weight for display
                    const latest = data.point[data.point.length - 1];
                    const weightKg = latest.value[0].fpVal;
                    const weightDate = new Date(parseInt(latest.startTimeNanos) / 1000000);
                    
                    localStorage.setItem('hed_weight', weightKg.toFixed(1));
                    localStorage.setItem('hed_weight_date', weightDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    
                    // Build weight history - first weight of each day
                    const weightByDay = {};
                    for (const point of data.point) {
                        const date = new Date(parseInt(point.startTimeNanos) / 1000000);
                        const dateStr = date.toLocaleDateString('en-CA'); // YYYY-MM-DD
                        const weight = point.value[0].fpVal;
                        // Only store first weight of day
                        if (!weightByDay[dateStr]) {
                            weightByDay[dateStr] = weight;
                        }
                    }
                    
                    // Convert to sorted array (newest first)
                    const weightHistory = Object.entries(weightByDay)
                        .map(([date, weight]) => ({ date, weight: parseFloat(weight.toFixed(1)) }))
                        .sort((a, b) => b.date.localeCompare(a.date))
                        .slice(0, 30); // Keep last 30 days
                    
                    localStorage.setItem('hed_weight_history', JSON.stringify(weightHistory));
                    
                    updateUI();
                    toast('Weight: ' + weightKg.toFixed(1) + 'kg');
                } else {
                    toast('No weight data found');
                }
            } catch (e) {
                console.error('Weight sync error:', e);
                toast('Weight sync failed');
            }
        }
        
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        
        // Save food to FoodDB sheet if not already there
        async function saveToFoodDB(name, cal, protein, sodium) {
            if (!accessToken) return;
            // Check if already in database
            const exists = ALL_FOODS.some(f => f.name.toLowerCase() === name.toLowerCase());
            if (exists) return;
            
            try {
                // Append new row: Name, Cal, Protein, Sodium, Fiber, Sugar, Potassium, Calcium, Iron, VitD, Magnesium, Icon, Short
                // Estimate other nutrients based on cal/protein ratio
                const fiber = Math.round(cal / 200); // rough estimate
                const sugar = Math.round(cal / 50);
                const potassium = Math.round(cal * 0.5);
                const calcium = Math.round(protein * 3);
                const iron = Math.round(protein / 15);
                const vitD = 0;
                const magnesium = Math.round(cal / 20);
                const icon = 'üçΩÔ∏è';
                const short = name.length > 12 ? name.substring(0, 10) + '..' : '';
                
                const row = [[name, cal, protein, sodium, fiber, sugar, potassium, calcium, iron, vitD, magnesium, icon, short]];
                
                await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/FoodDB!A:M:append?valueInputOption=USER_ENTERED`, {
                    method: 'POST',
                    headers: { 
                        Authorization: `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ values: row })
                });
                
                // Add to local array
                ALL_FOODS.push({ name, cal, protein, sodium, fiber, sugar, potassium, calcium, iron, vitD, magnesium, icon, short });
                renderButtons();
                console.log('Saved to FoodDB:', name);
            } catch (e) {
                console.error('Save to FoodDB error:', e);
            }
        }
        
        // Save food with FULL nutrients to FoodDB sheet
        async function saveToFoodDBFull(name, cal, protein, nutrients) {
            if (!accessToken) return;
            const exists = ALL_FOODS.some(f => f.name.toLowerCase() === name.toLowerCase());
            if (exists) return;
            
            try {
                const icon = 'üçΩÔ∏è';
                const short = name.length > 12 ? name.substring(0, 10) + '..' : '';
                
                const row = [[name, cal, protein, nutrients.sodium, nutrients.fiber, nutrients.sugar, 
                              nutrients.potassium, nutrients.calcium, nutrients.iron, nutrients.vitD, 
                              nutrients.magnesium, icon, short]];
                
                await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/FoodDB!A:M:append?valueInputOption=USER_ENTERED`, {
                    method: 'POST',
                    headers: { 
                        Authorization: `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ values: row })
                });
                
                ALL_FOODS.push({ name, cal, protein, ...nutrients, icon, short });
                renderButtons();
                console.log('Saved to FoodDB (full):', name);
            } catch (e) {
                console.error('Save to FoodDB error:', e);
            }
        }
        
        // Input parsing
        function parseInput() {
            let input = document.getElementById('inputField').value.trim();
            if (!input) return;
            
            // Remove quotes and invisible characters
            input = input.replace(/^['"""']+|['"""']+$/g, '');
            input = input.replace(/[\u200B-\u200D\uFEFF\u00A0]/g, ''); // zero-width chars, nbsp
            
            // Match FULL nutrients: Name 000cal 00g 000mg 0f 0s 000k 00ca 0fe 0d 00ma
            // Order: cal, protein, sodium, fiber, sugar, potassium, calcium, iron, vitD, magnesium
            const matchFull = input.match(/^(.+?)\s+(\d+)\s*cal\s+(\d+)\s*g\s+(\d+)\s*mg\s+(\d+)\s*f\s+(\d+)\s*s\s+(\d+)\s*k\s+(\d+)\s*ca\s+(\d+)\s*fe\s+(\d+)\s*d\s+(\d+)\s*ma$/i);
            if (matchFull) {
                const name = matchFull[1].trim();
                const cal = parseInt(matchFull[2]);
                const protein = parseInt(matchFull[3]);
                const nutrients = {
                    sodium: parseInt(matchFull[4]),
                    fiber: parseInt(matchFull[5]),
                    sugar: parseInt(matchFull[6]),
                    potassium: parseInt(matchFull[7]),
                    calcium: parseInt(matchFull[8]),
                    iron: parseInt(matchFull[9]),
                    vitD: parseInt(matchFull[10]),
                    magnesium: parseInt(matchFull[11])
                };
                addFood(name, cal, protein, nutrients);
                saveToFoodDBFull(name, cal, protein, nutrients);
                document.getElementById('inputField').value = '';
                return;
            }
            
            // Match: Name 000cal 00g 000mg (with sodium only)
            const matchWithSodium = input.match(/^(.+?)\s+(\d+)\s*cal\s+(\d+)\s*g\s+(\d+)\s*mg$/i);
            if (matchWithSodium) {
                const name = matchWithSodium[1].trim();
                const cal = parseInt(matchWithSodium[2]);
                const protein = parseInt(matchWithSodium[3]);
                const sodium = parseInt(matchWithSodium[4]);
                addFood(name, cal, protein, { sodium });
                saveToFoodDB(name, cal, protein, sodium);
                document.getElementById('inputField').value = '';
                return;
            }
            
            // Match: Name 000cal 00g (without sodium - estimate based on food type)
            const match = input.match(/^(.+?)\s+(\d+)\s*cal\s*(\d+)\s*g?$/i);
            if (match) {
                const name = match[1].trim();
                const cal = parseInt(match[2]);
                const protein = parseInt(match[3]);
                const estimatedSodium = Math.round(cal * 0.5);
                addFood(name, cal, protein, { sodium: estimatedSodium });
                saveToFoodDB(name, cal, protein, estimatedSodium); // Auto-save to sheet
                document.getElementById('inputField').value = '';
                return;
            }
            
            // Match: Name 000cal00g (no space between cal and protein)
            const match1b = input.match(/^(.+?)\s+(\d+)\s*cal(\d+)\s*g?$/i);
            if (match1b) {
                const name = match1b[1].trim();
                const cal = parseInt(match1b[2]);
                const protein = parseInt(match1b[3]);
                const estimatedSodium = Math.round(cal * 0.5);
                addFood(name, cal, protein, { sodium: estimatedSodium });
                saveToFoodDB(name, cal, protein, estimatedSodium); // Auto-save to sheet
                document.getElementById('inputField').value = '';
                return;
            }
            
            // Match: Name 000cal
            const match2 = input.match(/^(.+?)\s+(\d+)\s*cal$/i);
            if (match2) {
                const name = match2[1].trim();
                const cal = parseInt(match2[2]);
                const estimatedSodium = Math.round(cal * 0.5);
                addFood(name, cal, 0, { sodium: estimatedSodium });
                saveToFoodDB(name, cal, 0, estimatedSodium); // Auto-save to sheet
                document.getElementById('inputField').value = '';
                return;
            }
            
            // Match: 0000 steps
            const match3 = input.match(/^(\d+)\s*steps?$/i);
            if (match3) {
                document.getElementById('stepsInput').value = match3[1];
                saveManualSteps();
                document.getElementById('inputField').value = '';
                return;
            }
            
            toast('Format: Food 650cal 35g 800mg');
        }
        
        document.getElementById('inputField').addEventListener('keypress', e => { if (e.key === 'Enter') parseInput(); });
        
        // Copy functions
        function copySummary() {
            const net = state.calIn - state.calOut;
            const text = `Cal: ${state.calIn}/1600 | Protein: ${state.protein}/110g | Burned: ${state.calOut} | Net: ${net}`;
            navigator.clipboard.writeText(text);
            toast('Summary copied!');
        }
        
        function copyFull() {
            const date = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            let text = `HED ${date}:\n`;
            state.entries.forEach(e => {
                if (e.type === 'food') text += `‚Ä¢ ${e.name} (${e.cal}/${e.protein}g)\n`;
                else text += `‚Ä¢ ${e.name} (${e.cal} cal)\n`;
            });
            const net = state.calIn - state.calOut;
            text += `---\nCal: ${state.calIn}/1600 | Protein: ${state.protein}/110g | Burned: ${state.calOut} | Net: ${net}`;
            navigator.clipboard.writeText(text);
            toast('Full log copied!');
        }
        
        // Start
        window.onload = function() {
            // Check for clear parameter
            if (window.location.search.includes('clear=1')) {
                localStorage.clear();
                window.location.href = window.location.pathname;
                return;
            }
            init();
        };
    </script>
    <script src="https://accounts.google.com/gsi/client" async></script>
</body>
</html>
