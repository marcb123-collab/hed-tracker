<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Marc's HED Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .dashboard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 14px;
            padding-top: max(12px, env(safe-area-inset-top));
        }
        
        .dash-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .dash-title { font-size: 16px; font-weight: 600; }
        .dash-date { font-size: 12px; opacity: 0.9; }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .stat {
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 8px 6px;
            text-align: center;
        }
        
        .stat-value { font-size: 18px; font-weight: 700; }
        .stat-label { font-size: 9px; opacity: 0.8; text-transform: uppercase; }
        
        .progress-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .progress-item { flex: 1; }
        .progress-label { font-size: 9px; opacity: 0.8; margin-bottom: 2px; }
        .progress-bar { height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }
        .progress-fill { height: 100%; background: white; border-radius: 2px; transition: width 0.3s; }
        
        .status-row {
            display: flex;
            gap: 6px;
            font-size: 11px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .status-chip {
            background: rgba(255,255,255,0.15);
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .deficit { color: #90EE90; }
        .over { color: #FFB6C1; }
        
        .copy-btn {
            background: rgba(255,255,255,0.25);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .copy-btn:active { background: rgba(255,255,255,0.4); }
        
        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            font-size: 12px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #666;
        }
        
        .tab.active { color: #667eea; border-bottom-color: #667eea; font-weight: 600; }
        
        /* Content */
        .content { flex: 1; overflow-y: auto; }
        .pane { display: none; padding: 10px; }
        .pane.active { display: block; }
        
        /* Summary */
        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .summary-list { font-size: 12px; }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .summary-item:last-child { border-bottom: none; }
        
        .item-left { display: flex; align-items: center; gap: 6px; flex: 1; }
        .item-dot { width: 6px; height: 6px; border-radius: 50%; }
        .item-dot.food { background: #4CAF50; }
        .item-dot.exercise { background: #2196F3; }
        .item-name { flex: 1; }
        .item-values { color: #666; font-size: 11px; }
        .item-delete { background: none; border: none; color: #ccc; font-size: 16px; padding: 0 4px; cursor: pointer; }
        .item-delete:hover { color: #f44336; }
        
        .no-entries { color: #999; text-align: center; padding: 20px; font-size: 13px; }
        
        /* Quick buttons */
        .section-title {
            font-size: 11px;
            font-weight: 600;
            color: #666;
            margin: 12px 0 8px 0;
        }
        
        .quick-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .qbtn {
            background: #f5f5f5;
            border: none;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .qbtn:active { background: #e8e8e8; }
        .qbtn.food { border-left: 3px solid #4CAF50; }
        .qbtn.exercise { border-left: 3px solid #2196F3; }
        .qbtn.action { background: #E8F0FE; border-left: 3px solid #4285F4; }
        .qbtn.photo { background: #FFF3E0; border-left: 3px solid #FF9800; }
        
        .qbtn-cal { color: #888; font-size: 10px; }
        
        /* Input bar */
        .input-bar {
            background: white;
            padding: 10px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        
        .input-field {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }
        
        .input-field:focus { border-color: #667eea; }
        
        .input-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .input-btn.add { background: #667eea; color: white; }
        .input-btn.photo { background: #FF9800; color: white; }
        
        /* History */
        .history-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .history-date {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        .history-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            font-size: 11px;
            text-align: center;
        }
        
        .history-stat-value { font-weight: 600; font-size: 14px; }
        .history-stat-label { color: #888; font-size: 9px; }
        .history-stat.good .history-stat-value { color: #4CAF50; }
        .history-stat.bad .history-stat-value { color: #f44336; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        
        .modal.open { display: flex; }
        
        .modal-box {
            background: white;
            border-radius: 14px;
            padding: 20px;
            width: 90%;
            max-width: 320px;
        }
        
        .modal-title { font-size: 16px; font-weight: 600; margin-bottom: 14px; }
        
        .modal-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .modal-btns { display: flex; gap: 10px; justify-content: flex-end; }
        
        .modal-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            cursor: pointer;
        }
        
        .modal-btn.cancel { background: #f0f0f0; }
        .modal-btn.save { background: #667eea; color: white; }
        
        .photo-preview { max-width: 100%; max-height: 150px; border-radius: 8px; margin-bottom: 10px; }
        
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 13px;
            z-index: 200;
            display: none;
        }
        
        .toast.show { display: block; }
        
        /* Hidden */
        #photoInput, #cameraInput { display: none; }
    </style>
</head>
<body>
    <!-- Dashboard -->
    <div class="dashboard">
        <div class="dash-header">
            <span class="dash-title">Marc's HED Tracker <span id="syncStatus" style="font-size:10px;">‚ö™</span></span>
            <span class="dash-date" id="dateDisplay"></span>
        </div>
        <div class="stats-row">
            <div class="stat">
                <div class="stat-value" id="calIn">0</div>
                <div class="stat-label">Cal In</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="protein">0</div>
                <div class="stat-label">Protein</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="burned">0</div>
                <div class="stat-label">Burned</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="net">0</div>
                <div class="stat-label">Net</div>
            </div>
        </div>
        <div class="progress-row">
            <div class="progress-item">
                <div class="progress-label">Calories <span id="calPct">0</span>%</div>
                <div class="progress-bar"><div class="progress-fill" id="calBar" style="width:0%"></div></div>
            </div>
            <div class="progress-item">
                <div class="progress-label">Protein <span id="worPct">0</span>%</div>
                <div class="progress-bar"><div class="progress-fill" id="worBar" style="width:0%"></div></div>
            </div>
        </div>
        <div class="status-row">
            <span class="status-chip">vs Target: <span id="deficit" class="deficit">0</span></span>
            <span class="status-chip" id="steps">0/7500 steps</span>
            <button class="copy-btn" id="workoutBtn" onclick="toggleWorkout()">‚¨ú Workout</button>
            <button class="copy-btn" onclick="copySummary()">üìã Summary</button>
            <button class="copy-btn" onclick="copyFull()">üìã Today</button>
        </div>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="showPane('today')">Today</button>
        <button class="tab" onclick="showPane('add')">Add</button>
        <button class="tab" onclick="showPane('plan')">Plan</button>
        <button class="tab" onclick="showPane('history')">History</button>
    </div>
    
    <!-- Content -->
    <div class="content">
        <!-- Today Pane -->
        <div class="pane active" id="todayPane">
            <div class="summary-card">
                <div class="summary-header">
                    <span>Today's Log</span>
                    <div>
                        <button class="qbtn action" onclick="refreshFromSheets()" style="font-size:10px;padding:4px 8px;">‚òÅÔ∏è Refresh</button>
                        <button class="qbtn action" onclick="syncSteps()" style="font-size:10px;padding:4px 8px;">üîÑ Steps</button>
                    </div>
                </div>
                <div class="summary-list" id="logList">
                    <div class="no-entries">No entries yet</div>
                </div>
            </div>
        </div>
        
        <!-- Add Pane -->
        <div class="pane" id="addPane">
            <div class="section-title">üì∏ PHOTO</div>
            <div class="quick-grid">
                <button class="qbtn photo" onclick="takePhoto()">üì∑ Camera</button>
                <button class="qbtn photo" onclick="uploadPhoto()">üñºÔ∏è Upload</button>
            </div>
            
            <div class="section-title">üçΩÔ∏è FOOD</div>
            <div class="quick-grid" id="foodButtons"></div>
            
            <div class="section-title">üí™ EXERCISE</div>
            <div class="quick-grid" id="exerciseButtons"></div>
            
            <div class="section-title">üîÑ SYNC</div>
            <div class="quick-grid">
                <button class="qbtn action" onclick="syncSteps()">üîÑ Sync Steps</button>
                <button class="qbtn action" onclick="refreshFromSheets()">‚òÅÔ∏è Refresh from Cloud</button>
                <button class="qbtn action" onclick="googleSignIn()" id="signInBtn" style="display:none;">üîë Sign In</button>
            </div>
        </div>
        
        <!-- Plan Pane -->
        <div class="pane" id="planPane">
            <div class="summary-card">
                <div class="summary-header">üìÖ Weekly Exercise Plan</div>
                <p style="font-size:11px;color:#666;margin-bottom:10px;">6-day rotation. Workout 10-11am (8-9am if calls). Sunday rest.</p>
            </div>
            <div id="planList"></div>
        </div>
        
        <!-- History Pane -->
        <div class="pane" id="historyPane">
            <div id="historyList"></div>
        </div>
    </div>
    
    <!-- Input Bar -->
    <div class="input-bar">
        <input type="text" class="input-field" id="inputField" placeholder="Paste: Saba Set 650cal 35g">
        <button class="input-btn photo" onclick="takePhoto()">üì∑</button>
        <button class="input-btn add" onclick="parseInput()">‚ñ∂</button>
    </div>
    
    <!-- Hidden inputs -->
    <input type="file" id="photoInput" accept="image/*" onchange="handlePhoto(event)">
    <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handlePhoto(event)">
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- Custom Food Modal -->
    <div class="modal" id="customModal">
        <div class="modal-box">
            <div class="modal-title">Add Custom Food</div>
            <input type="text" class="modal-input" id="customName" placeholder="Food name">
            <input type="number" class="modal-input" id="customCal" placeholder="Calories">
            <input type="number" class="modal-input" id="customPro" placeholder="Protein (g)">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeModal('customModal')">Cancel</button>
                <button class="modal-btn save" onclick="saveCustom()">Add</button>
            </div>
        </div>
    </div>
    
    <!-- Photo Modal -->
    <div class="modal" id="photoModal">
        <div class="modal-box">
            <div class="modal-title">Log Meal</div>
            <img id="photoPreview" class="photo-preview" style="display:none">
            <input type="text" class="modal-input" id="photoName" placeholder="Meal name">
            <input type="number" class="modal-input" id="photoCal" placeholder="Calories">
            <input type="number" class="modal-input" id="photoPro" placeholder="Protein (g)">
            <p style="font-size:11px;color:#888;margin-bottom:12px;">üí° Send photo to Claude for estimate</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeModal('photoModal')">Cancel</button>
                <button class="modal-btn save" onclick="savePhoto()">Add</button>
            </div>
        </div>
    </div>
    
    <!-- Steps Modal -->
    <div class="modal" id="stepsModal">
        <div class="modal-box">
            <div class="modal-title">Manual Steps</div>
            <input type="number" class="modal-input" id="stepsInput" placeholder="Number of steps">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeModal('stepsModal')">Cancel</button>
                <button class="modal-btn save" onclick="saveManualSteps()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Config
        const CLIENT_ID = '163799557992-hgstjj16f2d587jjicjonmlulaqsh552.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/fitness.activity.read https://www.googleapis.com/auth/spreadsheets';
        const SHEET_ID = '13jRxb7mOAZUyi1mO3z005W6gtG5Kh4X5PZPM4FTwNMY';
        const TARGETS = { cal: 1600, protein: 110 };
        
        let tokenClient, accessToken = localStorage.getItem('hed_token');
        let state = { date: '', calIn: 0, calOut: 0, protein: 0, steps: 0, workout: false, entries: [] };
        let photoData = null;
        
        // Weekly plan data
        const WEEKLY_PLAN = [
            { day: 'Monday', workout: 'Ab Circuit', cal: 200, time: '10-11am', details: 'Pilates warmup (15-20 min) + GymFiesta belly routine. 9 exercises, 3-4 sets, 14-20 reps.' },
            { day: 'Tuesday', workout: 'Bike', cal: 400, time: '10-11am', details: '35-40 min moderate pace, 350-450 kcal burn.' },
            { day: 'Wednesday', workout: 'Resistance', cal: 180, time: '10-11am', details: 'Muscle bending bar + resistance bands. 5 exercises each, 3 sets.' },
            { day: 'Thursday', workout: 'Ab Circuit', cal: 200, time: '10-11am', details: 'Pilates warmup (15-20 min) + GymFiesta belly routine. 9 exercises, 3-4 sets, 14-20 reps.' },
            { day: 'Friday', workout: 'Bike', cal: 400, time: '10-11am', details: '35-40 min moderate pace, 350-450 kcal burn.' },
            { day: 'Saturday', workout: 'Resistance', cal: 180, time: '10-11am', details: 'Muscle bending bar + resistance bands. 5 exercises each, 3 sets.' },
            { day: 'Sunday', workout: 'Rest Day', cal: 0, time: '', details: '45-60 min walk recommended.' },
        ];
        
        // Food and exercise items
        const ALL_FOODS = [
            { name: 'Baseline', cal: 78, protein: 1, icon: 'üìã' },
            { name: 'Rice Bread+Hummus', cal: 190, protein: 4, icon: 'üçû', short: 'Rice Bread' },
            { name: 'Asahi Shake', cal: 194, protein: 27, icon: 'ü•§', short: 'Asahi' },
            { name: 'Oikos 18g', cal: 100, protein: 18, icon: 'ü•õ', short: 'Oikos 18' },
            { name: 'Oikos 13g', cal: 90, protein: 13, icon: 'ü•õ', short: 'Oikos 13' },
            { name: 'Protein Bar', cal: 200, protein: 15, icon: 'üç´' },
            { name: 'Matcha Tall', cal: 150, protein: 3, icon: 'üçµ', short: 'Matcha T' },
            { name: 'Matcha Grande', cal: 200, protein: 4, icon: 'üçµ', short: 'Matcha G' },
            { name: 'Green Tea Pudding', cal: 120, protein: 3, icon: 'üçÆ', short: 'Pudding' },
            { name: 'Banana Bread', cal: 180, protein: 3, icon: 'üçå' },
        ];
        
        const ALL_EXERCISES = [
            { name: 'Pilates', cal: 90, icon: 'üßò' },
            { name: 'Pilates Lesson', cal: 180, icon: 'üßò' },
            { name: 'Ab Circuit', cal: 200, icon: 'üí™' },
            { name: 'Bike', cal: 400, icon: 'üö¥' },
            { name: 'Resistance', cal: 180, icon: 'üèãÔ∏è' },
            { name: 'Long Walk', cal: 150, icon: 'üö∂', short: 'Walk' },
            { name: 'Drums 1hr', cal: 175, icon: 'ü•Å', short: 'Drums 1h' },
            { name: 'Drums 2hr', cal: 350, icon: 'ü•Å', short: 'Drums 2h' },
        ];
        
        // Usage tracking
        let itemUsage = JSON.parse(localStorage.getItem('hed_usage') || '{}');
        
        function trackUsage(name) {
            itemUsage[name] = (itemUsage[name] || 0) + 1;
            localStorage.setItem('hed_usage', JSON.stringify(itemUsage));
        }
        
        function seedUsageFromState() {
            // Count from today's entries
            state.entries.forEach(e => {
                itemUsage[e.name] = (itemUsage[e.name] || 0) + 1;
            });
            localStorage.setItem('hed_usage', JSON.stringify(itemUsage));
        }
        
        async function seedUsageFromSheets() {
            if (!accessToken) return;
            try {
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/DailyLog!H2:H100`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                if (res.status !== 200) return;
                
                const data = await res.json();
                if (!data.values) return;
                
                // Count item occurrences from Items column
                data.values.forEach(row => {
                    if (row[0]) {
                        row[0].split(', ').forEach(item => {
                            const name = item.trim();
                            if (name) {
                                itemUsage[name] = (itemUsage[name] || 0) + 1;
                            }
                        });
                    }
                });
                localStorage.setItem('hed_usage', JSON.stringify(itemUsage));
                renderButtons();
                console.log('Seeded usage from sheets:', itemUsage);
            } catch (e) {
                console.error('Seed usage error:', e);
            }
        }
        
        function renderButtons() {
            // Sort foods by usage
            const sortedFoods = [...ALL_FOODS].sort((a, b) => (itemUsage[b.name] || 0) - (itemUsage[a.name] || 0));
            const foodHtml = sortedFoods.map(f => 
                `<button class="qbtn food" onclick="addFood('${f.name}',${f.cal},${f.protein})">${f.icon} ${f.short || f.name} <span class="qbtn-cal">${f.cal}/${f.protein}g</span></button>`
            ).join('') + `<button class="qbtn food" onclick="openCustom()">‚ûï Custom</button>`;
            document.getElementById('foodButtons').innerHTML = foodHtml;
            
            // Sort exercises by usage
            const sortedEx = [...ALL_EXERCISES].sort((a, b) => (itemUsage[b.name] || 0) - (itemUsage[a.name] || 0));
            const exHtml = sortedEx.map(e => 
                `<button class="qbtn exercise" onclick="addExercise('${e.name}',${e.cal})">${e.icon} ${e.short || e.name} <span class="qbtn-cal">${e.cal}</span></button>`
            ).join('') + `<button class="qbtn exercise" onclick="toggleWorkout()">‚úÖ Workout Done</button>`;
            document.getElementById('exerciseButtons').innerHTML = exHtml;
        }
        
        function updateSyncStatus() {
            const el = document.getElementById('syncStatus');
            if (accessToken) {
                el.textContent = 'üü¢';
                el.title = 'Signed in';
            } else {
                el.textContent = '‚ö™';
                el.title = 'Not signed in';
            }
        }
        
        // Init
        async function init() {
            state.date = new Date().toDateString();
            loadState();
            seedUsageFromState();
            updateUI();
            initGoogle();
            scheduleMidnightSave();
        }
        
        function initGoogle() {
            if (typeof google === 'undefined') {
                setTimeout(initGoogle, 200);
                return;
            }
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: async (r) => {
                    if (r.access_token) {
                        accessToken = r.access_token;
                        localStorage.setItem('hed_token', accessToken);
                        document.getElementById('signInBtn').style.display = 'none';
                        updateSyncStatus();
                        // Load from Sheets after sign-in
                        const loaded = await loadFromLiveData();
                        if (loaded) {
                            updateUI();
                            toast('Synced from cloud!');
                        }
                        seedUsageFromSheets();
                        syncSteps();
                    }
                }
            });
            if (!accessToken) {
                document.getElementById('signInBtn').style.display = 'inline-flex';
            } else {
                document.getElementById('signInBtn').style.display = 'none';
                // Try to load from Sheets on startup
                loadFromLiveData().then(loaded => {
                    if (loaded) {
                        updateUI();
                        toast('Synced from cloud');
                    }
                });
                seedUsageFromSheets();
            }
            updateSyncStatus();
        }
        
        function googleSignIn() { tokenClient.requestAccessToken(); }
        
        // State
        function loadState() {
            const today = new Date().toDateString();
            const saved = localStorage.getItem('hed_state');
            if (saved) {
                const parsed = JSON.parse(saved);
                if (parsed.date === today) {
                    state = parsed;
                } else {
                    saveToHistory(parsed);
                    saveToSheets(parsed);
                    state.date = today;
                }
            } else {
                state.date = today;
            }
        }
        
        function saveState() {
            state.date = new Date().toDateString();
            localStorage.setItem('hed_state', JSON.stringify(state));
            syncToLiveData(); // Sync to Sheets on every save
        }
        
        // Sync current state to LiveData sheet
        async function syncToLiveData() {
            if (!accessToken) return;
            const today = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD format
            const row = [today, state.calIn, state.protein, state.calOut, state.steps, state.calIn - state.calOut, state.workout ? 'Yes' : 'No', JSON.stringify(state.entries)];
            try {
                await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/LiveData!A2:H2?valueInputOption=RAW`, {
                    method: 'PUT',
                    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: [row] })
                });
                console.log('Synced to LiveData');
            } catch (e) { 
                console.error('LiveData sync error:', e); 
            }
        }
        
        // Load state from LiveData sheet
        async function loadFromLiveData() {
            if (!accessToken) return false;
            try {
                // First ensure headers exist
                await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/LiveData!A1:H1?valueInputOption=RAW`, {
                    method: 'PUT',
                    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: [['Date', 'Cal In', 'Protein', 'Cal Out', 'Steps', 'Net', 'Workout', 'Entries']] })
                });
                
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/LiveData!A2:H2`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                
                if (res.status === 401) {
                    localStorage.removeItem('hed_token');
                    accessToken = null;
                    return false;
                }
                
                const data = await res.json();
                const today = new Date().toLocaleDateString('en-CA');
                
                if (data.values && data.values[0] && data.values[0][0] === today) {
                    const row = data.values[0];
                    state.date = new Date().toDateString();
                    state.calIn = parseInt(row[1]) || 0;
                    state.protein = parseInt(row[2]) || 0;
                    state.calOut = parseInt(row[3]) || 0;
                    state.steps = parseInt(row[4]) || 0;
                    state.workout = row[6] === 'Yes';
                    try { 
                        state.entries = JSON.parse(row[7] || '[]'); 
                    } catch { 
                        state.entries = []; 
                    }
                    localStorage.setItem('hed_state', JSON.stringify(state));
                    console.log('Loaded from LiveData:', state);
                    return true;
                } else if (data.values && data.values[0] && data.values[0][0]) {
                    // Different day - archive old data first
                    console.log('New day detected, archiving old data');
                    await archiveToDaily(data.values[0]);
                }
                return false;
            } catch (e) { 
                console.error('LoadFromLiveData error:', e);
                return false; 
            }
        }
        
        // Archive a day's data to DailyLog
        async function archiveToDaily(row) {
            if (!accessToken) return;
            try {
                // Ensure headers
                await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/DailyLog!A1:H1?valueInputOption=RAW`, {
                    method: 'PUT',
                    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: [['Date', 'Cal In', 'Protein', 'Cal Out', 'Steps', 'Net', 'Workout', 'Items']] })
                });
                
                // Convert entries JSON to item names
                let items = '';
                try {
                    const entries = JSON.parse(row[7] || '[]');
                    items = entries.map(e => e.name).join(', ');
                } catch {}
                
                const archiveRow = [row[0], row[1], row[2], row[3], row[4], row[5], row[6], items];
                
                await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/DailyLog!A:H:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS`, {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: [archiveRow] })
                });
                console.log('Archived to DailyLog');
            } catch (e) {
                console.error('Archive error:', e);
            }
        }
        
        // Manual refresh button
        async function refreshFromSheets() {
            toast('Refreshing...');
            const loaded = await loadFromLiveData();
            if (loaded) {
                updateUI();
                toast('Synced from cloud!');
            } else {
                toast('No cloud data or not signed in');
            }
        }
        
        function saveToHistory(data) {
            if (!data.calIn && !data.entries.length) return;
            let history = JSON.parse(localStorage.getItem('hed_history') || '[]');
            history.unshift({ date: data.date, calIn: data.calIn, calOut: data.calOut, protein: data.protein, steps: data.steps, workout: data.workout });
            localStorage.setItem('hed_history', JSON.stringify(history.slice(0, 30)));
        }
        
        async function saveToSheets(data) {
            if (!accessToken || (!data.calIn && !data.entries.length)) return;
            const row = [data.date, data.calIn, data.protein, data.calOut, data.steps, data.calIn - data.calOut, data.workout ? 'Yes' : 'No', data.entries.map(e => e.name).join(', ')];
            try {
                const check = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/A1`, { headers: { Authorization: `Bearer ${accessToken}` } });
                const checkData = await check.json();
                if (!checkData.values) {
                    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/A1:H1?valueInputOption=RAW`, {
                        method: 'PUT',
                        headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ values: [['Date', 'Cal In', 'Protein', 'Cal Out', 'Steps', 'Net', 'Workout', 'Items']] })
                    });
                }
                await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/A:H:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS`, {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: [row] })
                });
            } catch (e) { console.error(e); }
        }
        
        function scheduleMidnightSave() {
            const now = new Date();
            const midnight = new Date(now);
            midnight.setHours(24, 0, 0, 0);
            const ms = midnight - now;
            setTimeout(() => {
                saveToHistory(state);
                saveToSheets(state);
                state = { date: new Date().toDateString(), calIn: 0, calOut: 0, protein: 0, steps: 0, workout: false, entries: [] };
                saveState();
                updateUI();
                scheduleMidnightSave();
            }, ms);
        }
        
        // UI
        function updateUI() {
            document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            document.getElementById('calIn').textContent = state.calIn;
            document.getElementById('protein').textContent = state.protein + 'g';
            document.getElementById('burned').textContent = state.calOut;
            const net = state.calIn - state.calOut;
            document.getElementById('net').textContent = net;
            
            const calPct = Math.min(Math.round((state.calIn / TARGETS.cal) * 100), 100);
            const worPct = Math.min(Math.round((state.protein / TARGETS.protein) * 100), 100);
            document.getElementById('calPct').textContent = calPct;
            document.getElementById('worPct').textContent = worPct;
            document.getElementById('calBar').style.width = calPct + '%';
            document.getElementById('worBar').style.width = worPct + '%';
            
            const deficit = net - TARGETS.cal;
            const defEl = document.getElementById('deficit');
            defEl.textContent = deficit;
            defEl.className = deficit <= 0 ? 'deficit' : 'over';
            
            document.getElementById('steps').textContent = state.steps.toLocaleString() + '/7500 steps';
            document.getElementById('workoutBtn').textContent = state.workout ? '‚úÖ Workout' : '‚¨ú Workout';
            
            renderLog();
            renderHistory();
            renderPlan();
            renderButtons();
        }
        
        function renderPlan() {
            const todayName = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            const list = document.getElementById('planList');
            if (!list) return;
            
            list.innerHTML = WEEKLY_PLAN.map(p => `
                <div class="summary-card" style="${p.day === todayName ? 'border-left: 4px solid #667eea; background: #f8f9ff;' : ''}">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <span style="font-weight:600;font-size:13px;">${p.day}${p.day === todayName ? ' (TODAY)' : ''}</span>
                        <span style="font-size:11px;color:#666;">${p.time}</span>
                    </div>
                    <div style="font-size:12px;color:#333;margin-bottom:4px;">üí™ ${p.workout} ${p.cal ? `(${p.cal} cal)` : ''}</div>
                    <div style="font-size:11px;color:#666;">${p.details}</div>
                </div>
            `).join('');
        }
        
        function renderLog() {
            const list = document.getElementById('logList');
            if (!state.entries.length) {
                list.innerHTML = '<div class="no-entries">No entries yet</div>';
                return;
            }
            list.innerHTML = state.entries.map((e, i) => `
                <div class="summary-item">
                    <div class="item-left">
                        <div class="item-dot ${e.type}"></div>
                        <span class="item-name">${e.name}</span>
                    </div>
                    <span class="item-values">${e.type === 'food' ? e.cal + '/' + e.protein + 'g' : e.cal + ' cal'}</span>
                    <button class="item-delete" onclick="deleteEntry(${i})">√ó</button>
                </div>
            `).join('');
        }
        
        function renderHistory() {
            // First show local history
            const history = JSON.parse(localStorage.getItem('hed_history') || '[]');
            const list = document.getElementById('historyList');
            if (!history.length) {
                list.innerHTML = '<div class="no-entries">No history yet</div>';
            } else {
                list.innerHTML = history.map(d => `
                    <div class="history-card">
                        <div class="history-date"><span>${d.date}</span><span>${d.workout ? '‚úÖ' : '‚¨ú'}</span></div>
                        <div class="history-stats">
                            <div class="history-stat ${d.calIn <= TARGETS.cal ? 'good' : 'bad'}"><div class="history-stat-value">${d.calIn}</div><div class="history-stat-label">Cal In</div></div>
                            <div class="history-stat ${d.protein >= TARGETS.protein ? 'good' : ''}"><div class="history-stat-value">${d.protein}g</div><div class="history-stat-label">Protein</div></div>
                            <div class="history-stat"><div class="history-stat-value">${d.calOut}</div><div class="history-stat-label">Burned</div></div>
                            <div class="history-stat"><div class="history-stat-value">${(d.steps||0).toLocaleString()}</div><div class="history-stat-label">Steps</div></div>
                        </div>
                    </div>
                `).join('');
            }
            
            // Then try to load from Sheets if we don't have much local history
            if (history.length < 5 && accessToken) {
                loadHistoryFromSheets();
            }
        }
        
        async function loadHistoryFromSheets() {
            if (!accessToken) return;
            try {
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/DailyLog!A2:H100`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                if (res.status !== 200) return;
                
                const data = await res.json();
                if (!data.values || !data.values.length) return;
                
                // Convert sheet rows to history format
                const sheetHistory = data.values.map(row => ({
                    date: row[0],
                    calIn: parseInt(row[1]) || 0,
                    protein: parseInt(row[2]) || 0,
                    calOut: parseInt(row[3]) || 0,
                    steps: parseInt(row[4]) || 0,
                    workout: row[6] === 'Yes'
                })).reverse(); // Most recent first
                
                // Merge with local history (dedupe by date)
                const localHistory = JSON.parse(localStorage.getItem('hed_history') || '[]');
                const localDates = new Set(localHistory.map(h => h.date));
                const merged = [...localHistory];
                
                sheetHistory.forEach(h => {
                    if (!localDates.has(h.date)) {
                        merged.push(h);
                    }
                });
                
                // Sort by date descending and save
                merged.sort((a, b) => new Date(b.date) - new Date(a.date));
                localStorage.setItem('hed_history', JSON.stringify(merged.slice(0, 30)));
                
                // Re-render
                const list = document.getElementById('historyList');
                list.innerHTML = merged.slice(0, 30).map(d => `
                    <div class="history-card">
                        <div class="history-date"><span>${d.date}</span><span>${d.workout ? '‚úÖ' : '‚¨ú'}</span></div>
                        <div class="history-stats">
                            <div class="history-stat ${d.calIn <= TARGETS.cal ? 'good' : 'bad'}"><div class="history-stat-value">${d.calIn}</div><div class="history-stat-label">Cal In</div></div>
                            <div class="history-stat ${d.protein >= TARGETS.protein ? 'good' : ''}"><div class="history-stat-value">${d.protein}g</div><div class="history-stat-label">Protein</div></div>
                            <div class="history-stat"><div class="history-stat-value">${d.calOut}</div><div class="history-stat-label">Burned</div></div>
                            <div class="history-stat"><div class="history-stat-value">${(d.steps||0).toLocaleString()}</div><div class="history-stat-label">Steps</div></div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Load history error:', e);
            }
        }
        
        function showPane(name) {
            // Remove active from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            // Remove active from all panes
            const panes = document.querySelectorAll('.pane');
            panes.forEach(p => p.classList.remove('active'));
            
            // Add active to selected tab
            if (name === 'today') tabs[0].classList.add('active');
            else if (name === 'add') tabs[1].classList.add('active');
            else if (name === 'plan') tabs[2].classList.add('active');
            else if (name === 'history') tabs[3].classList.add('active');
            
            // Add active to selected pane
            const pane = document.getElementById(name + 'Pane');
            if (pane) pane.classList.add('active');
        }
        
        function toast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
        
        // Actions
        function addFood(name, cal, protein) {
            state.calIn += cal;
            state.protein += protein;
            state.entries.push({ type: 'food', name, cal, protein, time: Date.now() });
            trackUsage(name);
            saveState();
            updateUI();
            toast('Added ' + name);
        }
        
        function addExercise(name, cal) {
            state.calOut += cal;
            state.entries.push({ type: 'exercise', name, cal, time: Date.now() });
            trackUsage(name);
            saveState();
            updateUI();
            toast('Added ' + name);
        }
        
        function deleteEntry(i) {
            const e = state.entries[i];
            if (e.type === 'food') {
                state.calIn -= e.cal;
                state.protein -= e.protein;
            } else {
                state.calOut -= e.cal;
                if (e.steps) state.steps = 0;
            }
            state.entries.splice(i, 1);
            saveState();
            updateUI();
        }
        
        function toggleWorkout() {
            state.workout = !state.workout;
            saveState();
            updateUI();
            toast(state.workout ? 'Workout done! üí™' : 'Workout unmarked');
        }
        
        // Steps
        async function syncSteps() {
            if (!accessToken) { googleSignIn(); return; }
            toast('Syncing steps...');
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            try {
                const res = await fetch('https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate', {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        aggregateBy: [{ dataTypeName: 'com.google.step_count.delta', dataSourceId: 'derived:com.google.step_count.delta:com.google.android.gms:estimated_steps' }],
                        bucketByTime: { durationMillis: 86400000 },
                        startTimeMillis: start,
                        endTimeMillis: now.getTime()
                    })
                });
                if (res.status === 401) {
                    localStorage.removeItem('hed_token');
                    accessToken = null;
                    document.getElementById('signInBtn').style.display = 'inline-flex';
                    updateSyncStatus();
                    toast('Please sign in again');
                    return;
                }
                const data = await res.json();
                let steps = 0;
                data.bucket?.forEach(b => b.dataset?.forEach(d => d.point?.forEach(p => { steps += p.value?.[0]?.intVal || 0; })));
                
                const oldCal = Math.round(state.steps * 0.04);
                const newCal = Math.round(steps * 0.04);
                state.calOut = state.calOut - oldCal + newCal;
                state.steps = steps;
                
                const idx = state.entries.findIndex(e => e.name?.includes('Steps'));
                if (idx >= 0) state.entries[idx] = { type: 'exercise', name: 'Steps (Synced)', cal: newCal, steps, time: Date.now() };
                else state.entries.push({ type: 'exercise', name: 'Steps (Synced)', cal: newCal, steps, time: Date.now() });
                
                saveState();
                updateUI();
                toast(steps.toLocaleString() + ' steps synced');
            } catch (e) {
                console.error(e);
                toast('Sync failed');
            }
        }
        
        function saveManualSteps() {
            const steps = parseInt(document.getElementById('stepsInput').value) || 0;
            const oldCal = Math.round(state.steps * 0.04);
            const newCal = Math.round(steps * 0.04);
            state.calOut = state.calOut - oldCal + newCal;
            state.steps = steps;
            
            const idx = state.entries.findIndex(e => e.name?.includes('Steps'));
            if (idx >= 0) state.entries[idx] = { type: 'exercise', name: 'Steps (Manual)', cal: newCal, steps, time: Date.now() };
            else state.entries.push({ type: 'exercise', name: 'Steps (Manual)', cal: newCal, steps, time: Date.now() });
            
            saveState();
            updateUI();
            closeModal('stepsModal');
            showPane('today');
            toast(steps.toLocaleString() + ' steps logged');
        }
        
        // Photo
        function takePhoto() { document.getElementById('cameraInput').click(); }
        function uploadPhoto() { document.getElementById('photoInput').click(); }
        
        function handlePhoto(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                photoData = ev.target.result;
                document.getElementById('photoPreview').src = photoData;
                document.getElementById('photoPreview').style.display = 'block';
                document.getElementById('photoModal').classList.add('open');
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }
        
        function savePhoto() {
            const name = document.getElementById('photoName').value || 'Meal';
            const cal = parseInt(document.getElementById('photoCal').value) || 0;
            const protein = parseInt(document.getElementById('photoPro').value) || 0;
            state.calIn += cal;
            state.protein += protein;
            state.entries.push({ type: 'food', name, cal, protein, photo: photoData, time: Date.now() });
            saveState();
            updateUI();
            closeModal('photoModal');
            document.getElementById('photoName').value = '';
            document.getElementById('photoCal').value = '';
            document.getElementById('photoPro').value = '';
            photoData = null;
            showPane('today');
            toast('Added ' + name);
        }
        
        // Custom
        function openCustom() { document.getElementById('customModal').classList.add('open'); }
        
        function saveCustom() {
            const name = document.getElementById('customName').value || 'Custom';
            const cal = parseInt(document.getElementById('customCal').value) || 0;
            const protein = parseInt(document.getElementById('customPro').value) || 0;
            addFood(name, cal, protein);
            closeModal('customModal');
            document.getElementById('customName').value = '';
            document.getElementById('customCal').value = '';
            document.getElementById('customPro').value = '';
        }
        
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        
        // Input parsing
        function parseInput() {
            let input = document.getElementById('inputField').value.trim();
            if (!input) return;
            
            // Remove quotes and invisible characters
            input = input.replace(/^['"""']+|['"""']+$/g, '');
            input = input.replace(/[\u200B-\u200D\uFEFF\u00A0]/g, ''); // zero-width chars, nbsp
            
            // Match: Name 000cal 00g (with or without space, g optional)
            const match = input.match(/^(.+?)\s+(\d+)\s*cal\s*(\d+)\s*g?$/i);
            if (match) {
                addFood(match[1].trim(), parseInt(match[2]), parseInt(match[3]));
                document.getElementById('inputField').value = '';
                return;
            }
            
            // Match: Name 000cal00g (no space between cal and protein)
            const match1b = input.match(/^(.+?)\s+(\d+)\s*cal(\d+)\s*g?$/i);
            if (match1b) {
                addFood(match1b[1].trim(), parseInt(match1b[2]), parseInt(match1b[3]));
                document.getElementById('inputField').value = '';
                return;
            }
            
            // Match: Name 000cal
            const match2 = input.match(/^(.+?)\s+(\d+)\s*cal$/i);
            if (match2) {
                addFood(match2[1].trim(), parseInt(match2[2]), 0);
                document.getElementById('inputField').value = '';
                return;
            }
            
            // Match: 0000 steps
            const match3 = input.match(/^(\d+)\s*steps?$/i);
            if (match3) {
                document.getElementById('stepsInput').value = match3[1];
                saveManualSteps();
                document.getElementById('inputField').value = '';
                return;
            }
            
            toast('Format: Saba Set 650cal 35g');
        }
        
        document.getElementById('inputField').addEventListener('keypress', e => { if (e.key === 'Enter') parseInput(); });
        
        // Copy functions
        function copySummary() {
            const net = state.calIn - state.calOut;
            const text = `Cal: ${state.calIn}/1600 | Protein: ${state.protein}/110g | Burned: ${state.calOut} | Net: ${net}`;
            navigator.clipboard.writeText(text);
            toast('Summary copied!');
        }
        
        function copyFull() {
            const date = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            let text = `HED ${date}:\n`;
            state.entries.forEach(e => {
                if (e.type === 'food') text += `‚Ä¢ ${e.name} (${e.cal}/${e.protein}g)\n`;
                else text += `‚Ä¢ ${e.name} (${e.cal} cal)\n`;
            });
            const net = state.calIn - state.calOut;
            text += `---\nCal: ${state.calIn}/1600 | Protein: ${state.protein}/110g | Burned: ${state.calOut} | Net: ${net}`;
            navigator.clipboard.writeText(text);
            toast('Full log copied!');
        }
        
        // Start
        window.onload = init;
    </script>
    <script src="https://accounts.google.com/gsi/client" async></script>
</body>
</html>
