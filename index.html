<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Marc's HED Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .dashboard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 14px;
            padding-top: max(12px, env(safe-area-inset-top));
        }
        
        .dash-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .dash-title { font-size: 16px; font-weight: 600; }
        .dash-date { font-size: 12px; opacity: 0.9; }
        .sync-indicator { font-size: 10px; margin-left: 8px; }
        .sync-indicator.green { color: #90EE90; }
        .sync-indicator.yellow { color: #FFD700; }
        .sync-indicator.red { color: #FFB6C1; }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .stat {
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 8px 6px;
            text-align: center;
        }
        
        .stat-value { font-size: 18px; font-weight: 700; }
        .stat-label { font-size: 9px; opacity: 0.8; text-transform: uppercase; }
        
        .progress-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .progress-item { flex: 1; }
        .progress-label { font-size: 9px; opacity: 0.8; margin-bottom: 2px; }
        .progress-bar { height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }
        .progress-fill { height: 100%; background: white; border-radius: 2px; transition: width 0.3s; }
        
        .status-row {
            display: flex;
            gap: 6px;
            font-size: 11px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .status-chip { background: rgba(255,255,255,0.15); padding: 4px 8px; border-radius: 12px; }
        .deficit { color: #90EE90; }
        .over { color: #FFB6C1; }
        
        .copy-btn {
            background: rgba(255,255,255,0.25);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .copy-btn:active { background: rgba(255,255,255,0.4); }
        
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tab {
            flex: 1;
            padding: 10px 4px;
            border: none;
            background: none;
            font-size: 11px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #666;
        }
        
        .tab.active { color: #667eea; border-bottom-color: #667eea; font-weight: 600; }
        
        .content { flex: 1; overflow-y: auto; padding-bottom: 70px; }
        .pane { display: none; padding: 10px; }
        .pane.active { display: block; }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .item-list { font-size: 12px; }
        
        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .item-row:last-child { border-bottom: none; }
        
        .item-left { display: flex; align-items: center; gap: 6px; flex: 1; }
        .item-dot { width: 6px; height: 6px; border-radius: 50%; }
        .item-dot.food { background: #4CAF50; }
        .item-dot.exercise { background: #2196F3; }
        .item-name { flex: 1; }
        .item-values { color: #666; font-size: 11px; }
        .item-delete { background: none; border: none; color: #ccc; font-size: 16px; padding: 0 4px; cursor: pointer; }
        .item-delete:hover { color: #f44336; }
        
        .no-entries { color: #999; text-align: center; padding: 20px; font-size: 13px; }
        
        .section-title { font-size: 11px; font-weight: 600; color: #666; margin: 12px 0 8px 0; }
        
        .quick-grid { display: flex; flex-wrap: wrap; gap: 6px; }
        
        .qbtn {
            background: #f5f5f5;
            border: none;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .qbtn:active { background: #e8e8e8; }
        .qbtn.food { border-left: 3px solid #4CAF50; }
        .qbtn.exercise { border-left: 3px solid #2196F3; }
        .qbtn.action { background: #E8F0FE; border-left: 3px solid #4285F4; }
        .qbtn.photo { background: #FFF3E0; border-left: 3px solid #FF9800; }
        .qbtn.more { background: #f0f0f0; border-left: 3px solid #999; }
        
        .qbtn-cal { color: #888; font-size: 10px; }
        
        .input-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 10px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        
        .input-field {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }
        
        .input-field:focus { border-color: #667eea; }
        
        .input-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .input-btn.add { background: #667eea; color: white; }
        .input-btn.add:active { background: #5a6fd6; }
        .input-btn.photo { background: #FF9800; color: white; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        .shake { animation: shake 0.3s; }
        
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        
        .modal.open { display: flex; }
        
        .modal-box {
            background: white;
            border-radius: 14px;
            padding: 20px;
            width: 90%;
            max-width: 320px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title { font-size: 16px; font-weight: 600; margin-bottom: 14px; }
        
        .modal-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .modal-btns { display: flex; gap: 10px; justify-content: flex-end; }
        
        .modal-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            cursor: pointer;
        }
        
        .modal-btn.cancel { background: #f0f0f0; }
        .modal-btn.save { background: #667eea; color: white; }
        
        .photo-preview { max-width: 100%; max-height: 150px; border-radius: 8px; margin-bottom: 10px; }
        
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 13px;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .toast.show { opacity: 1; }
        
        .plan-day {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .plan-day.today { border-left: 4px solid #667eea; background: #f8f9ff; }
        
        .plan-day-header {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
        }
        
        .plan-day-workout { font-size: 12px; color: #333; }
        .plan-day-details { font-size: 11px; color: #666; margin-top: 6px; line-height: 1.4; }
        
        #photoInput, #cameraInput { display: none; }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="dash-header">
            <span class="dash-title">Marc's HED Tracker <span class="sync-indicator" id="syncIndicator">‚ö™</span></span>
            <span class="dash-date" id="dateDisplay"></span>
        </div>
        <div class="stats-row">
            <div class="stat"><div class="stat-value" id="calIn">0</div><div class="stat-label">Cal In</div></div>
            <div class="stat"><div class="stat-value" id="protein">0</div><div class="stat-label">Protein</div></div>
            <div class="stat"><div class="stat-value" id="burned">0</div><div class="stat-label">Burned</div></div>
            <div class="stat"><div class="stat-value" id="net">0</div><div class="stat-label">Net</div></div>
        </div>
        <div class="progress-row">
            <div class="progress-item">
                <div class="progress-label">Calories <span id="calPct">0</span>%</div>
                <div class="progress-bar"><div class="progress-fill" id="calBar" style="width:0%"></div></div>
            </div>
            <div class="progress-item">
                <div class="progress-label">Protein <span id="worPct">0</span>%</div>
                <div class="progress-bar"><div class="progress-fill" id="worBar" style="width:0%"></div></div>
            </div>
        </div>
        <div class="status-row">
            <span class="status-chip">vs Target: <span id="deficit" class="deficit">0</span></span>
            <span class="status-chip" id="stepsDisplay">0 steps</span>
            <span class="status-chip" id="workoutDisplay">‚¨ú</span>
            <button class="copy-btn" onclick="copySummary()">üìã Summary</button>
            <button class="copy-btn" onclick="copyFull()">üìã Full</button>
        </div>
    </div>
    
    <div class="tabs">
        <button class="tab active" id="tabToday" onclick="showPane('today')">Today</button>
        <button class="tab" id="tabAdd" onclick="showPane('add')">Add</button>
        <button class="tab" id="tabPlan" onclick="showPane('plan')">Plan</button>
        <button class="tab" id="tabHistory" onclick="showPane('history')">History</button>
    </div>
    
    <div class="content">
        <!-- Today Pane -->
        <div class="pane active" id="paneToday">
            <div class="card">
                <div class="card-header">
                    <span>Today's Log</span>
                    <button class="qbtn action" onclick="manualSync()" style="font-size:10px;padding:4px 8px;">üîÑ Sync</button>
                </div>
                <div class="item-list" id="logList">
                    <div class="no-entries">No entries yet</div>
                </div>
            </div>
            
            <div class="section-title">‚ö° QUICK ADD</div>
            <div class="quick-grid" id="quickItems"></div>
            <button class="qbtn more" onclick="showPane('add')" style="width:100%;justify-content:center;margin-top:8px;">More Items ‚Üí</button>
        </div>
        
        <!-- Add Pane -->
        <div class="pane" id="paneAdd">
            <div class="section-title">üì∏ PHOTO</div>
            <div class="quick-grid">
                <button class="qbtn photo" onclick="takePhoto()">üì∑ Camera</button>
                <button class="qbtn photo" onclick="uploadPhoto()">üñºÔ∏è Upload</button>
            </div>
            
            <div class="section-title">üçΩÔ∏è FOOD</div>
            <div class="quick-grid" id="allFoodItems"></div>
            
            <div class="section-title">üí™ EXERCISE</div>
            <div class="quick-grid" id="allExerciseItems"></div>
            
            <div class="section-title">üîÑ SYNC</div>
            <div class="quick-grid">
                <button class="qbtn action" onclick="syncSteps()">üîÑ Sync Steps</button>
                <button class="qbtn action" id="signInBtn" onclick="doSignIn()">üîë Sign In to Google</button>
                <button class="qbtn action" onclick="manualSync()">üì• Sync with Sheets</button>
            </div>
        </div>
        
        <!-- Plan Pane -->
        <div class="pane" id="panePlan">
            <div class="card">
                <div class="card-header">üìÖ Weekly Exercise Plan</div>
                <p style="font-size:11px;color:#666;">6-day rotation. Workout 10-11am (8-9am if calls). Sunday rest.</p>
            </div>
            <div id="planList"></div>
        </div>
        
        <!-- History Pane -->
        <div class="pane" id="paneHistory">
            <div id="historyList"></div>
        </div>
    </div>
    
    <div class="input-bar">
        <input type="text" class="input-field" id="inputField" placeholder="Paste: Saba Set 650cal 35g">
        <button class="input-btn photo" onclick="takePhoto()">üì∑</button>
        <button class="input-btn add" id="addBtn" onclick="parseInput()">+</button>
    </div>
    
    <input type="file" id="photoInput" accept="image/*" onchange="handlePhoto(event)">
    <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handlePhoto(event)">
    
    <div class="toast" id="toast"></div>
    
    <!-- Modals -->
    <div class="modal" id="customModal">
        <div class="modal-box">
            <div class="modal-title">Add Custom Food</div>
            <input type="text" class="modal-input" id="customName" placeholder="Food name">
            <input type="number" class="modal-input" id="customCal" placeholder="Calories">
            <input type="number" class="modal-input" id="customPro" placeholder="Protein (g)">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeModal('customModal')">Cancel</button>
                <button class="modal-btn save" onclick="saveCustom()">Add</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="photoModal">
        <div class="modal-box">
            <div class="modal-title">Log Meal</div>
            <img id="photoPreview" class="photo-preview" style="display:none">
            <input type="text" class="modal-input" id="photoName" placeholder="Meal name">
            <input type="number" class="modal-input" id="photoCal" placeholder="Calories">
            <input type="number" class="modal-input" id="photoPro" placeholder="Protein (g)">
            <p style="font-size:11px;color:#888;margin-bottom:12px;">üí° Send photo to Claude for estimate</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeModal('photoModal')">Cancel</button>
                <button class="modal-btn save" onclick="savePhoto()">Add</button>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIG =====
        const CLIENT_ID = '163799557992-hgstjj16f2d587jjicjonmlulaqsh552.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/fitness.activity.read https://www.googleapis.com/auth/spreadsheets';
        const SHEET_ID = '13jRxb7mOAZUyi1mO3z005W6gtG5Kh4X5PZPM4FTwNMY';
        const TARGETS = { cal: 1600, protein: 110 };
        
        // ===== DATA =====
        const ALL_FOODS = [
            { name: 'Baseline', cal: 78, protein: 1, icon: 'üìã' },
            { name: 'Rice Bread+Hummus', cal: 190, protein: 4, icon: 'üçû' },
            { name: 'Asahi Shake', cal: 194, protein: 27, icon: 'ü•§' },
            { name: 'Oikos 18g', cal: 100, protein: 18, icon: 'ü•õ' },
            { name: 'Oikos 13g', cal: 90, protein: 13, icon: 'ü•õ' },
            { name: 'Protein Bar', cal: 200, protein: 15, icon: 'üç´' },
            { name: 'Matcha Tall', cal: 150, protein: 3, icon: 'üçµ' },
            { name: 'Matcha Grande', cal: 200, protein: 4, icon: 'üçµ' },
            { name: 'Green Tea Pudding', cal: 120, protein: 3, icon: 'üçÆ' },
            { name: 'Banana Bread', cal: 180, protein: 3, icon: 'üçå' },
        ];
        
        const ALL_EXERCISES = [
            { name: 'Pilates', cal: 90, icon: 'üßò' },
            { name: 'Pilates Lesson', cal: 180, icon: 'üßò' },
            { name: 'Ab Circuit', cal: 200, icon: 'üí™' },
            { name: 'Bike', cal: 400, icon: 'üö¥' },
            { name: 'Resistance', cal: 180, icon: 'üèãÔ∏è' },
            { name: 'Long Walk', cal: 150, icon: 'üö∂' },
            { name: 'Drums 1hr', cal: 175, icon: 'ü•Å' },
            { name: 'Drums 2hr', cal: 350, icon: 'ü•Å' },
        ];
        
        const WEEKLY_PLAN = [
            { day: 'Monday', workout: 'Ab Circuit', time: '10-11am', details: 'Pilates warmup (15-20 min) + GymFiesta belly routine. 9 exercises, 3-4 sets, 14-20 reps.' },
            { day: 'Tuesday', workout: 'Bike', time: '10-11am', details: '35-40 min moderate pace, 350-450 kcal burn.' },
            { day: 'Wednesday', workout: 'Resistance', time: '10-11am', details: 'Muscle bending bar + resistance bands. 5 exercises each, 3 sets.' },
            { day: 'Thursday', workout: 'Ab Circuit', time: '10-11am', details: 'Pilates warmup (15-20 min) + GymFiesta belly routine. 9 exercises, 3-4 sets, 14-20 reps.' },
            { day: 'Friday', workout: 'Bike', time: '10-11am', details: '35-40 min moderate pace, 350-450 kcal burn.' },
            { day: 'Saturday', workout: 'Resistance', time: '10-11am', details: 'Muscle bending bar + resistance bands. 5 exercises each, 3 sets.' },
            { day: 'Sunday', workout: 'Rest Day', time: '', details: '45-60 min walk recommended.' },
        ];
        
        // ===== STATE =====
        let tokenClient = null;
        let accessToken = null;
        let state = { date: '', calIn: 0, calOut: 0, protein: 0, steps: 0, workout: false, entries: [] };
        let itemUsage = {};
        let photoData = null;
        let googleReady = false;
        
        // ===== INIT =====
        function init() {
            console.log('HED Tracker initializing...');
            
            // Load local data
            loadLocalState();
            loadUsage();
            
            // Render UI
            updateUI();
            renderAllItems();
            renderPlan();
            
            // Check for new day
            const today = new Date().toDateString();
            if (state.date && state.date !== today) {
                console.log('New day detected, archiving...');
                archiveDay();
            }
            state.date = today;
            saveLocalState();
            
            console.log('Init complete. State:', state);
        }
        
        // ===== GOOGLE AUTH =====
        function onGoogleLoad() {
            console.log('Google Identity Services loaded');
            googleReady = true;
            
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: onTokenResponse
            });
            
            // Check for saved token
            accessToken = localStorage.getItem('hed_token');
            if (accessToken) {
                console.log('Found saved token');
                document.getElementById('signInBtn').textContent = '‚úì Signed In';
                setSyncStatus('green');
            }
        }
        
        function onTokenResponse(response) {
            console.log('Token response:', response);
            if (response.access_token) {
                accessToken = response.access_token;
                localStorage.setItem('hed_token', accessToken);
                document.getElementById('signInBtn').textContent = '‚úì Signed In';
                toast('Signed in successfully!');
                setSyncStatus('green');
                syncToSheets();
            } else if (response.error) {
                console.error('Auth error:', response.error);
                toast('Sign in failed');
                setSyncStatus('red');
            }
        }
        
        function doSignIn() {
            console.log('Sign in requested, googleReady:', googleReady);
            if (!googleReady) {
                toast('Google loading... try again');
                return;
            }
            tokenClient.requestAccessToken();
        }
        
        // ===== SHEETS SYNC =====
        async function syncToSheets() {
            if (!accessToken) {
                console.log('No token, skipping sync');
                return;
            }
            
            setSyncStatus('yellow');
            console.log('Syncing to sheets...');
            
            try {
                // Ensure tabs exist
                await ensureSheetTabs();
                
                // Write current day
                const today = new Date().toLocaleDateString('en-CA');
                const data = [today, state.calIn, state.protein, state.calOut, state.steps, state.calIn - state.calOut, state.workout ? 'Yes' : 'No', JSON.stringify(state.entries)];
                
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/CurrentDay!A2:H2?valueInputOption=RAW`, {
                    method: 'PUT',
                    headers: { 'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: [data] })
                });
                
                if (res.status === 401) {
                    console.log('Token expired');
                    localStorage.removeItem('hed_token');
                    accessToken = null;
                    document.getElementById('signInBtn').textContent = 'üîë Sign In to Google';
                    setSyncStatus('red');
                    toast('Session expired - sign in again');
                    return;
                }
                
                console.log('Sync successful');
                setSyncStatus('green');
            } catch (e) {
                console.error('Sync error:', e);
                setSyncStatus('red');
            }
        }
        
        async function syncFromSheets() {
            if (!accessToken) return;
            
            setSyncStatus('yellow');
            
            try {
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/CurrentDay!A2:H2`, {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });
                
                if (res.status === 401) {
                    localStorage.removeItem('hed_token');
                    accessToken = null;
                    return;
                }
                
                const data = await res.json();
                const today = new Date().toLocaleDateString('en-CA');
                
                if (data.values && data.values[0] && data.values[0][0] === today) {
                    const row = data.values[0];
                    state.calIn = parseInt(row[1]) || 0;
                    state.protein = parseInt(row[2]) || 0;
                    state.calOut = parseInt(row[3]) || 0;
                    state.steps = parseInt(row[4]) || 0;
                    state.workout = row[6] === 'Yes';
                    try { state.entries = JSON.parse(row[7] || '[]'); } catch { state.entries = []; }
                    saveLocalState();
                    updateUI();
                    toast('Synced from Sheets');
                }
                
                setSyncStatus('green');
            } catch (e) {
                console.error('Sync from sheets error:', e);
                setSyncStatus('red');
            }
        }
        
        async function ensureSheetTabs() {
            try {
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}`, {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });
                const data = await res.json();
                const sheets = data.sheets ? data.sheets.map(s => s.properties.title) : [];
                
                const requests = [];
                if (!sheets.includes('CurrentDay')) {
                    requests.push({ addSheet: { properties: { title: 'CurrentDay' } } });
                }
                if (!sheets.includes('DailyLog')) {
                    requests.push({ addSheet: { properties: { title: 'DailyLog' } } });
                }
                
                if (requests.length > 0) {
                    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}:batchUpdate`, {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ requests })
                    });
                    
                    // Add headers
                    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/CurrentDay!A1:H1?valueInputOption=RAW`, {
                        method: 'PUT',
                        headers: { 'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ values: [['Date', 'Cal In', 'Protein', 'Cal Out', 'Steps', 'Net', 'Workout', 'Entries']] })
                    });
                    
                    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/DailyLog!A1:H1?valueInputOption=RAW`, {
                        method: 'PUT',
                        headers: { 'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ values: [['Date', 'Cal In', 'Protein', 'Cal Out', 'Steps', 'Net', 'Workout', 'Items']] })
                    });
                }
            } catch (e) {
                console.error('Error ensuring tabs:', e);
            }
        }
        
        function manualSync() {
            if (!accessToken) {
                toast('Sign in first');
                doSignIn();
                return;
            }
            syncFromSheets();
            syncToSheets();
        }
        
        // ===== LOCAL STORAGE =====
        function saveLocalState() {
            localStorage.setItem('hed_state', JSON.stringify(state));
        }
        
        function loadLocalState() {
            try {
                const saved = localStorage.getItem('hed_state');
                if (saved) {
                    state = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error loading state:', e);
            }
            state.date = state.date || new Date().toDateString();
            state.entries = state.entries || [];
        }
        
        function loadUsage() {
            try {
                const saved = localStorage.getItem('hed_usage');
                if (saved) itemUsage = JSON.parse(saved);
            } catch (e) {}
        }
        
        function saveUsage() {
            localStorage.setItem('hed_usage', JSON.stringify(itemUsage));
        }
        
        function archiveDay() {
            // Save to local history
            const history = JSON.parse(localStorage.getItem('hed_history') || '[]');
            if (state.calIn > 0 || state.entries.length > 0) {
                history.unshift({
                    date: state.date,
                    calIn: state.calIn,
                    calOut: state.calOut,
                    protein: state.protein,
                    steps: state.steps,
                    workout: state.workout
                });
                localStorage.setItem('hed_history', JSON.stringify(history.slice(0, 30)));
            }
            
            // Reset state
            state = { date: new Date().toDateString(), calIn: 0, calOut: 0, protein: 0, steps: 0, workout: false, entries: [] };
        }
        
        // ===== UI =====
        function setSyncStatus(color) {
            const el = document.getElementById('syncIndicator');
            el.className = 'sync-indicator ' + color;
            el.textContent = color === 'green' ? 'üü¢' : color === 'yellow' ? 'üü°' : color === 'red' ? 'üî¥' : '‚ö™';
        }
        
        function updateUI() {
            document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            document.getElementById('calIn').textContent = state.calIn;
            document.getElementById('protein').textContent = state.protein + 'g';
            document.getElementById('burned').textContent = state.calOut;
            
            const net = state.calIn - state.calOut;
            document.getElementById('net').textContent = net;
            
            const calPct = Math.min(Math.round((state.calIn / TARGETS.cal) * 100), 100);
            const worPct = Math.min(Math.round((state.protein / TARGETS.protein) * 100), 100);
            document.getElementById('calPct').textContent = calPct;
            document.getElementById('worPct').textContent = worPct;
            document.getElementById('calBar').style.width = calPct + '%';
            document.getElementById('worBar').style.width = worPct + '%';
            
            const deficit = net - TARGETS.cal;
            const defEl = document.getElementById('deficit');
            defEl.textContent = deficit;
            defEl.className = deficit <= 0 ? 'deficit' : 'over';
            
            document.getElementById('stepsDisplay').textContent = state.steps.toLocaleString() + ' steps';
            document.getElementById('workoutDisplay').textContent = state.workout ? '‚úÖ' : '‚¨ú';
            
            renderLog();
            renderQuickItems();
            renderHistory();
        }
        
        function renderLog() {
            const list = document.getElementById('logList');
            if (!state.entries || state.entries.length === 0) {
                list.innerHTML = '<div class="no-entries">No entries yet. Tap Add to log food or exercise.</div>';
                return;
            }
            list.innerHTML = state.entries.map((e, i) => `
                <div class="item-row">
                    <div class="item-left">
                        <div class="item-dot ${e.type}"></div>
                        <span class="item-name">${e.name}</span>
                    </div>
                    <span class="item-values">${e.type === 'food' ? e.cal + '/' + e.protein + 'g' : e.cal + ' cal'}</span>
                    <button class="item-delete" onclick="deleteEntry(${i})">√ó</button>
                </div>
            `).join('');
        }
        
        function renderQuickItems() {
            // Get most used items (top 8)
            const allItems = [...ALL_FOODS, ...ALL_EXERCISES];
            const sorted = allItems.sort((a, b) => (itemUsage[b.name] || 0) - (itemUsage[a.name] || 0));
            const top = sorted.slice(0, 8);
            
            let html = top.map(item => {
                if (item.protein !== undefined) {
                    return `<button class="qbtn food" onclick="addFood('${item.name}',${item.cal},${item.protein})">${item.icon} ${item.name.split(' ')[0]} <span class="qbtn-cal">${item.cal}/${item.protein}g</span></button>`;
                } else {
                    return `<button class="qbtn exercise" onclick="addExercise('${item.name}',${item.cal})">${item.icon} ${item.name} <span class="qbtn-cal">${item.cal}</span></button>`;
                }
            }).join('');
            
            html += `<button class="qbtn food" onclick="openCustom()">‚ûï Custom</button>`;
            document.getElementById('quickItems').innerHTML = html;
        }
        
        function renderAllItems() {
            // Foods
            let foodHtml = ALL_FOODS.map(f => 
                `<button class="qbtn food" onclick="addFood('${f.name}',${f.cal},${f.protein})">${f.icon} ${f.name} <span class="qbtn-cal">${f.cal}/${f.protein}g</span></button>`
            ).join('');
            foodHtml += `<button class="qbtn food" onclick="openCustom()">‚ûï Custom</button>`;
            document.getElementById('allFoodItems').innerHTML = foodHtml;
            
            // Exercises
            let exHtml = ALL_EXERCISES.map(e => 
                `<button class="qbtn exercise" onclick="addExercise('${e.name}',${e.cal})">${e.icon} ${e.name} <span class="qbtn-cal">${e.cal}</span></button>`
            ).join('');
            exHtml += `<button class="qbtn exercise" onclick="toggleWorkout()">‚úÖ Workout Done</button>`;
            document.getElementById('allExerciseItems').innerHTML = exHtml;
        }
        
        function renderPlan() {
            const todayName = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            
            const html = WEEKLY_PLAN.map(p => `
                <div class="plan-day ${p.day === todayName ? 'today' : ''}">
                    <div class="plan-day-header">
                        <span>${p.day}${p.day === todayName ? ' (TODAY)' : ''}</span>
                        <span>${p.time}</span>
                    </div>
                    <div class="plan-day-workout">üí™ ${p.workout}</div>
                    <div class="plan-day-details">${p.details}</div>
                </div>
            `).join('');
            
            document.getElementById('planList').innerHTML = html;
        }
        
        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('hed_history') || '[]');
            const list = document.getElementById('historyList');
            
            if (history.length === 0) {
                list.innerHTML = '<div class="no-entries">No history yet</div>';
                return;
            }
            
            list.innerHTML = history.map(d => `
                <div class="card">
                    <div class="card-header"><span>${d.date}</span><span>${d.workout ? '‚úÖ' : '‚¨ú'}</span></div>
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;text-align:center;font-size:11px;">
                        <div><div style="font-weight:600;font-size:14px;color:${d.calIn <= TARGETS.cal ? '#4CAF50' : '#f44336'}">${d.calIn}</div><div style="color:#888">Cal In</div></div>
                        <div><div style="font-weight:600;font-size:14px;color:${d.protein >= TARGETS.protein ? '#4CAF50' : '#666'}">${d.protein}g</div><div style="color:#888">Protein</div></div>
                        <div><div style="font-weight:600;font-size:14px">${d.calOut}</div><div style="color:#888">Burned</div></div>
                        <div><div style="font-weight:600;font-size:14px">${(d.steps||0).toLocaleString()}</div><div style="color:#888">Steps</div></div>
                    </div>
                </div>
            `).join('');
        }
        
        function showPane(name) {
            // Update tabs
            document.getElementById('tabToday').classList.toggle('active', name === 'today');
            document.getElementById('tabAdd').classList.toggle('active', name === 'add');
            document.getElementById('tabPlan').classList.toggle('active', name === 'plan');
            document.getElementById('tabHistory').classList.toggle('active', name === 'history');
            
            // Update panes
            document.getElementById('paneToday').classList.toggle('active', name === 'today');
            document.getElementById('paneAdd').classList.toggle('active', name === 'add');
            document.getElementById('panePlan').classList.toggle('active', name === 'plan');
            document.getElementById('paneHistory').classList.toggle('active', name === 'history');
        }
        
        function toast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(()
